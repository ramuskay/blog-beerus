<!DOCTYPE html><html lang="fr"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="theme-color" content="#3F80FF"/><meta data-react-helmet="true" name="google-site-verification" content="18MIKg3LXM5E_B-fq-2nGUfIsFItgDJlbt6lMVSGtUw"/><meta data-react-helmet="true" name="twitter:image" content="https://blog.beerus.fr/static/9ea3747d497ad41230fd09f582184574/thumbnail.svg"/><meta data-react-helmet="true" name="twitter:description" content="Architecture Je suis en train de préparer la Certified Kubernetes Administrator (CKA) et il me faudrait un lab pour m&#x27;exercer. J&#x27;ai pas mal…"/><meta data-react-helmet="true" name="twitter:title" content="Déployer son infra K3S sur Proxmox en mode IaC"/><meta data-react-helmet="true" name="twitter:creator" content=""/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" property="og:image" content="https://blog.beerus.fr/static/9ea3747d497ad41230fd09f582184574/thumbnail.svg"/><meta data-react-helmet="true" property="og:description" content="Architecture Je suis en train de préparer la Certified Kubernetes Administrator (CKA) et il me faudrait un lab pour m&#x27;exercer. J&#x27;ai pas mal…"/><meta data-react-helmet="true" property="og:title" content="Déployer son infra K3S sur Proxmox en mode IaC"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:url" content="https://blog.beerus.fr/deploy-k3s-proxmox"/><meta data-react-helmet="true" name="image" content="https://blog.beerus.fr/static/9ea3747d497ad41230fd09f582184574/thumbnail.svg"/><meta data-react-helmet="true" name="description" content="Architecture Je suis en train de préparer la Certified Kubernetes Administrator (CKA) et il me faudrait un lab pour m&#x27;exercer. J&#x27;ai pas mal…"/><meta name="generator" content="Gatsby 4.14.0"/><style data-href="/styles.a6f6fde9679e5026779c.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:400;src:url(/static/roboto-400-465390c6e54c60f4a15ff698f372e858.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:500;src:url(/static/roboto-500-324b1e6d0f5ae7c6ab42fed5516c7b3d.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Roboto;font-style:normal;font-weight:700;src:url(/static/roboto-700-18034c13b329fd74d51af5c9e2ddee1e.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Roboto Mono;font-style:normal;font-weight:400;src:url(/static/roboto-mono-400-336c829bcd5d167e6d7942a2bd64c703.woff) format("woff");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:PerfectDOS;src:url(/static/PerfectDos-4df1d5bd795358c80faab26511d48071.ttf) format("truetype")}*,:after,:before,html{-webkit-box-sizing:border-box;box-sizing:border-box}body,figure{margin:0}html{font:normal normal normal 1rem/1.6 Helvetica Neue,Roboto,-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif;font-family:Helvetica Neue,Roboto,-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif;font-size:84%!important}body{color:#454545;font-size:1rem;-webkit-transition:background .4s ease;transition:background .4s ease}@media(min-width:620px){body{font-size:1.15rem}}.gatsby-resp-iframe-wrapper,dl,ol,p,table,ul,video{font-size:1.25rem;margin:0 0 1.5rem}@media(min-width:620px){.gatsby-resp-iframe-wrapper,dl,ol,p,table,ul,video{font-size:1.35rem;margin:0 0 2rem}}ul li p{margin:0}ul li ul{margin:0;padding-left:1rem}ul li ul li{margin:.25rem 0}ol li ol{margin-bottom:0}h1,h2,h3,h4,h5{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#111;font-family:Roboto,-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif;font-weight:500;line-height:1.3}h1,h1:not(:first-child),h2,h2:not(:first-child),h3,h3:not(:first-child),h4,h4:not(:first-child),h5,h5:not(:first-child){margin:0 0 1rem}h1{font-size:1.95rem;font-weight:500}h1 code{font-size:1.95rem!important}h2{font-size:1.8rem;font-weight:500;padding-bottom:.2rem}h2 code{font-size:1.8rem!important}h3{color:#444;font-size:1.6rem}h3,h4{font-weight:500}h4{color:#777;font-size:1.4rem}h5{font-size:1.3rem;font-weight:500}@media(min-width:620px){h1,h2,h3,h4,h5{margin:0 0 2rem}h1:not(:first-child),h2:not(:first-child),h3:not(:first-child),h4:not(:first-child),h5:not(:first-child){margin:0 0 1.5rem}h1{font-size:2.6rem}h1 code{font-size:2.6rem!important}h2{font-size:2.3rem}h2 code{font-size:2.3rem!important}h3{font-size:1.95rem}h4{font-size:1.6rem}h5{font-size:1.5rem}}ul{padding:0}ul li{list-style-type:none;margin-bottom:.3rem;margin-left:.5rem;padding-left:1.5rem;position:relative}ul li.task-list-item{margin-left:0;padding-left:0}ul li.task-list-item:before{content:""}ul li:before{color:#929292;content:"•";font-size:22px;left:0;line-height:1.1;position:absolute}@media(min-width:620px){ul li{margin-left:1.5rem;padding-left:1.5rem}}a{color:#5183f5;font-weight:500;text-decoration:none}a:active,a:focus,a:hover{color:#2161f2}.lead a:not(.button):not(.anchor):not(.gatsby-resp-image-link),.lead a:not(span.gatsby-resp-image-wrapper),.page a:not(.button):not(.anchor):not(.gatsby-resp-image-link),.page a:not(span.gatsby-resp-image-wrapper),.post a:not(.button):not(.anchor):not(.gatsby-resp-image-link),.post a:not(span.gatsby-resp-image-wrapper){border-radius:4px;padding:1px 2px}.lead a:not(.button):not(.anchor):not(.gatsby-resp-image-link):hover,.lead a:not(span.gatsby-resp-image-wrapper):hover,.page a:not(.button):not(.anchor):not(.gatsby-resp-image-link):hover,.page a:not(span.gatsby-resp-image-wrapper):hover,.post a:not(.button):not(.anchor):not(.gatsby-resp-image-link):hover,.post a:not(span.gatsby-resp-image-wrapper):hover{background:#2161f2;color:#f0f4fe}.lead a:not(.button):not(.anchor):not(.gatsby-resp-image-link):active,.lead a:not(.button):not(.anchor):not(.gatsby-resp-image-link):focus,.lead a:not(span.gatsby-resp-image-wrapper):active,.lead a:not(span.gatsby-resp-image-wrapper):focus,.page a:not(.button):not(.anchor):not(.gatsby-resp-image-link):active,.page a:not(.button):not(.anchor):not(.gatsby-resp-image-link):focus,.page a:not(span.gatsby-resp-image-wrapper):active,.page a:not(span.gatsby-resp-image-wrapper):focus,.post a:not(.button):not(.anchor):not(.gatsby-resp-image-link):active,.post a:not(.button):not(.anchor):not(.gatsby-resp-image-link):focus,.post a:not(span.gatsby-resp-image-wrapper):active,.post a:not(span.gatsby-resp-image-wrapper):focus{background:#0c49d4;color:#f0f4fe}.lead img,.page img,.post img{height:auto;max-width:100%}mark{background:#ffeea8;padding:0 .2rem}b,strong{font-weight:600}blockquote cite{display:block;text-align:right}hr{border:0;border-top:2px solid #ccc;height:0}dt{font-weight:500}dd{margin-bottom:.5rem}[type=checkbox]{margin-right:1rem}.text-right{text-align:right}.text-center{text-align:center}.text-justify{text-align:justify}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.vertical-center{-ms-flex-align:center;-ms-flex-pack:center;align-items:center;justify-content:center}.flex,.vertical-center{display:-ms-flexbox;display:flex}.show{display:block!important}.hide{display:none!important}.invisible{visibility:hidden}.green{color:#1fc844}.pink{color:#ff5a5f}.blue{color:#5183f5}.yellow{color:#fec623}.crypto p{margin-bottom:.5rem}.screen-reader-text{clip:rect(1px,1px,1px,1px);height:1px;overflow:hidden;position:absolute!important;width:1px}.button,[type=button],[type=submit],a.button,button{-webkit-appearance:none;background:#5183f5;border:2px solid #5183f5;border-radius:6px;color:#fff;cursor:pointer;display:inline-block;font-family:Helvetica Neue,Roboto,-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif;font-size:1.1rem;font-weight:500;line-height:1;margin:0 0 .5rem;padding:.6rem .9rem;text-align:center;text-decoration:none;text-transform:none;vertical-align:middle}.button:active,.button:focus,.button:hover,[type=button]:active,[type=button]:focus,[type=button]:hover,[type=submit]:active,[type=submit]:focus,[type=submit]:hover,button:active,button:focus,button:hover{background:#0e51ec;border:2px solid #0e51ec;color:#fff;text-decoration:none}.button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=submit]::-moz-focus-inner,a.button::-moz-focus-inner,button::-moz-focus-inner{border:0;padding:0}.button:disabled,[type=button]:disabled,[type=submit]:disabled,a.button:disabled,button:disabled{cursor:default;pointer-events:none}.button:active,[type=button]:active,[type=submit]:active,a.button:active,button:active{-webkit-transform:scale(.95);transform:scale(.95)}.button.muted-button,a.button.muted-bottom{background:#e5e5e5;border:2px solid #e5e5e5;color:#454545}.button.muted-button:active,.button.muted-button:focus,.button.muted-button:hover,a.button.muted-bottom:active,a.button.muted-bottom:focus,a.button.muted-bottom:hover{background:#d9d9d9;border:2px solid #d9d9d9;color:#111}.twitter-button,a.twitter-button{background:#00aced;border:2px solid #00aced}.twitter-button:active,.twitter-button:focus,.twitter-button:hover,a.twitter-button:active,a.twitter-button:focus,a.twitter-button:hover{background:#0099d4;border:2px solid #0099d4;color:#fff}@media(min-width:620px){.button,[type=button],[type=submit],a.button,button{padding:.75rem 1.25rem}}[type=color],[type=date],[type=email],[type=number],[type=search],[type=text],[type=url],select,textarea{border:2px solid #ccc;border-radius:6px;display:block;font-size:1.1rem;font-weight:500;line-height:1;margin-bottom:.5rem;max-width:100%;outline:none;padding:.75rem;width:100%}[type=color]:hover,[type=date]:hover,[type=email]:hover,[type=number]:hover,[type=search]:hover,[type=text]:hover,[type=url]:hover,select:hover,textarea:hover{background:#f7f7f7;border:2px solid #b3b3b3}[type=color]:active,[type=color]:focus,[type=date]:active,[type=date]:focus,[type=email]:active,[type=email]:focus,[type=number]:active,[type=number]:focus,[type=search]:active,[type=search]:focus,[type=text]:active,[type=text]:focus,[type=url]:active,[type=url]:focus,select:active,select:focus,textarea:active,textarea:focus{background:#f0f4fe;border:2px solid #5183f5}textarea{height:auto;line-height:1.6;overflow:auto}fieldset{border:2px solid #ccc;border-radius:6px;margin:2rem 0;padding:60px}legend{font-weight:500;padding:0 .5rem}select{-webkit-appearance:none;-moz-appearance:none;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAAJCAYAAAA/33wPAAAAvklEQVQoFY2QMQqEMBBFv7ERa/EMXkGw11K8QbDXzuN4BHv7QO6ifUgj7v4UAdlVM8Uwf+b9YZJISnlqrfEUZVlinucnBGKaJgghbiHOyLyFKIoCbdvecpyReYvo/Ma2bajrGtbaC58kCdZ1RZ7nl/4/4d5EsO/7nzl7IUtodBexMMagaRrs+06JLMvcNWmaOv2W/C/TMAyD58dxROgSmvxFFMdxoOs6lliWBXEcuzokXRbRoJRyvqqqQvye+QDMDz1D6yuj9wAAAABJRU5ErkJggg==) 100% no-repeat;color:#454545;line-height:1}select::-ms-expand{display:none}[type=range]{width:100%}label{display:block;font-size:1rem;font-weight:700;margin:1rem 0 .5rem;max-width:100%}:-moz-placeholder,:-ms-input-placeholder,::-moz-placeholder,::-webkit-input-placeholder{color:#9a9a9a}table{border-collapse:collapse;border-spacing:0;display:block;max-width:100%;overflow-x:auto;white-space:nowrap;width:100%}th{border-bottom:2px solid #ccc}tfoot th{border-top:1px solid #ccc}td{border-bottom:1px solid #ccc}td,th{-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;padding:.75rem!important;text-align:left;width:100%;word-break:break-word}caption{caption-side:bottom;color:#ababab;padding:60px 0}tbody tr:nth-child(2n){background-color:#f8f8f8}.nav{background:#fff;left:0;position:fixed;top:0;-webkit-transition:background .4s ease;transition:background .4s ease;width:100%;z-index:3}.nav.scroll{-webkit-box-shadow:1px 2px 18px rgba(0,0,0,.1);box-shadow:1px 2px 18px rgba(0,0,0,.1)}.nav.scroll .nav-container{padding:0 1.5rem}.nav .cta{margin:0 0 0 .75rem}.nav .cta,.nav .nav-container{-ms-flex-align:center;align-items:center;display:-ms-flexbox;display:flex}.nav .nav-container{-ms-flex-pack:justify;height:55px;justify-content:space-between;margin:auto;max-width:800px;padding:1.5rem 1.5rem 0;-webkit-transition:height .4s ease;transition:height .4s ease}.nav .nav-container .nav-icon-hide-mobile{display:none}.nav .brand a{-ms-flex-align:center;align-items:center;color:#333;display:-ms-flexbox;display:flex;font-size:1.15rem;font-weight:500;margin-right:0}.nav .brand a:focus,.nav .brand a:hover{color:#000}.nav .links{-ms-flex-pack:end;-ms-flex-align:center;-ms-flex:1 1;flex:1 1;-ms-flex-direction:row;flex-direction:row;justify-content:flex-end;margin:0}.nav .links,.nav .links a{align-items:center;display:-ms-flexbox;display:flex}.nav .links a{-ms-flex-align:center;border-radius:6px;color:rgba(0,0,0,.6);font-size:1.05rem;font-weight:400;line-height:1.2;margin:.25rem;padding:.75rem;text-align:center}.nav .links a.active,.nav .links a:active,.nav .links a:hover{background:rgba(0,0,0,.05);color:#111}.favicon{border-radius:50%;height:40px;margin-bottom:0;margin-right:1rem;min-width:40px;width:40px}button.dark-switcher{-webkit-appearance:none;background:transparent;border:0;margin:0;padding:.75rem .5rem}button.dark-switcher:focus{outline:none}.nav-icons{height:1.3rem;margin-bottom:0;min-width:1.3rem;width:1.3rem}.github-nav-icon{color:#000}.camera-nav-icon{color:#bd0000}.twitter-nav-icon{color:#1da1f2}.sun-nav-icon{color:#fcc21b}.moon-nav-icon{color:#7890ff}@media(min-width:620px){.nav.scroll .nav-container{height:60px}.nav.scroll .favicon{height:40px;min-width:40px;width:40px}.nav .nav-container{height:160px;padding:0 2rem}.nav .nav-container .nav-icon-hide-mobile{display:-ms-flexbox;display:flex}.nav .brand a{font-size:1.3rem}.nav .brand .text{display:block}.nav .links{-ms-flex-pack:end;display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;height:100%;justify-content:flex-end}.nav .links a{border-bottom:2px solid transparent;font-size:1.2rem;margin:0 .5rem;padding:1rem}.nav .favicon{height:70px;margin-right:1rem;min-width:70px;width:70px}.nav button.dark-switcher{font-size:1.4rem;margin:0;padding:.75rem 1rem}.nav .nav-icons{height:1.65rem;margin-bottom:0;min-width:1.65rem;width:1.65rem}}@media print and (min-width:620px){.nav{display:none}}#main-content{margin-top:55px;min-height:calc(100vh - 190px);padding:40px 0 0}@media(min-width:620px){#main-content{margin-top:140px;min-height:calc(100vh - 360px)}}.container{margin-left:auto;margin-right:auto;max-width:800px;padding:0 1.5rem}@media(min-width:620px){.container{padding:0 2rem}}.lead{font-size:1.1rem;margin:0 auto}.lead h1{font-size:3.2rem;font-weight:600;margin-bottom:1.5rem;margin-top:0}.lead p{color:rgba(0,0,0,.6);font-size:1.6rem}.lead .button{margin-right:.5rem}@media screen and (min-width:750px){.lead{-ms-flex-align:center;align-items:center;display:-ms-flexbox;display:flex;font-size:1.2rem;line-height:1.5}.lead .elevator{-ms-flex:2 1;flex:2 1;margin-left:2rem}.lead h1{font-size:4rem}.lead p{font-size:1.65rem}.lead .button{margin-right:.5rem}}.callouts{display:none}@media(min-width:620px){.callouts{display:block}a.article-callout{-ms-flex-align:center;align-items:center;border:none!important;border-radius:4px;-webkit-box-shadow:1px 2px 10px rgba(0,0,0,.1);box-shadow:1px 2px 10px rgba(0,0,0,.1);color:#454545;display:-ms-flexbox;display:flex;font-size:1.5rem;font-weight:500;margin:1.5rem 0;padding:1.5rem;-webkit-transition:all .3s ease;transition:all .3s ease}a.article-callout:active,a.article-callout:focus,a.article-callout:hover{background:#fff;-webkit-box-shadow:3px 5px 20px rgba(0,0,0,.16);box-shadow:3px 5px 20px rgba(0,0,0,.16);color:#111}a.article-callout img{height:50px;margin:0 1.5rem 0 0;max-width:50px;width:50px}}.front-page{margin-top:2rem;padding:0 2rem}.front-page h2{-ms-flex-align:center;-ms-flex-pack:justify;align-items:center;border-bottom:0;display:-ms-flexbox;display:flex;justify-content:space-between;padding-bottom:0}@media(min-width:620px){.front-page h2{-ms-flex-pack:start;justify-content:flex-start}}.single .gatsby-image-wrapper{height:50px!important;width:50px!important}@media(min-width:620px){.single .gatsby-image-wrapper{-ms-flex-order:1;height:150px!important;margin-left:2rem;order:1;width:150px!important}.front-page{padding:0 4rem}}.single-header{display:grid;margin-bottom:30px}.single-header .flex,.single-header.no-thumbnail{display:-ms-flexbox;display:flex}.single-header .flex{-ms-flex-direction:column;flex-direction:column}.single-header h1{font-weight:600;margin:.5rem 0}.single-header .post-meta{margin-bottom:1rem}@media(min-width:620px){.single-header{display:grid;grid-template-columns:1fr 180px;margin-bottom:60px}.single-header h1{margin:0 0 .5rem}}.post-container{display:-ms-flexbox;display:flex}.posts a{display:block}.posts a .each{border:1px solid transparent;border-bottom-color:#ebebeb;display:grid;grid-template-columns:50px 1fr 0;margin:0;padding:1rem 0}.posts a .each .date{color:rgba(0,0,0,.4);font-size:.9rem;font-weight:400;margin:0}.posts a:last-of-type .each{border-bottom-color:transparent}.posts h2{border-bottom:none;font-size:1.25rem;font-weight:500;line-height:2rem;margin:0;padding:0}.posts .gatsby-image-wrapper{height:30px!important;margin-top:0;width:30px!important}.posts.simple a .each{-ms-flex-align:center;align-items:center;border:1px solid transparent;grid-template-columns:50px 2fr auto;margin:0;padding:.5rem 0}.posts.simple a .each:hover{background:#fff}.posts.simple a:last-of-type .each{border-bottom:1px solid transparent!important}.posts.simple .gatsby-image-wrapper{height:30px!important;margin-top:0;width:30px!important}.posts.simple h2{color:#454545;font-size:1.2rem;font-weight:500;margin:0;padding:0}.posts.simple h2:hover{color:#111}.posts .datetime{display:block}.posts .datetime,.posts .excerpt{color:rgba(0,0,0,.6);font-size:1.1rem;font-weight:400}.posts .excerpt{margin-top:1rem}@media(min-width:620px){.posts a .each{-ms-flex-align:start;align-items:start;grid-template-columns:80px 1fr;margin:0 -2rem;padding:2rem}.posts a .each:hover{background:#fafafa;border-radius:6px}.posts a .each:hover h2{color:#111}.posts a .each:active,.posts a .each:focus{background:#f0f4fe;border:1px dashed #5183f5}.posts a .each h2{font-size:1.35rem;line-height:2rem;margin:0 0 .25rem}.posts a .each .gatsby-image-wrapper{height:50px!important;margin-top:0;width:50px!important}.posts.simple a .each{border-bottom:1px solid #ebebeb;margin:0 -1rem;padding:.75rem 1rem}.posts.simple a .each:hover{background:#f2f2f2;border:1px solid #f2f2f2}.posts.simple a .each:active,.posts.simple a .each:focus{background:#f0f4fe;border:1px dashed #5183f5}.posts.simple a .each h2{font-size:1.3rem;margin:0}.posts.simple a .each .gatsby-image-wrapper{height:30px!important;width:30px!important}}.page h2,.post h2{border-bottom:1px solid #ebebeb}.tag-container a,.tag-container span{display:inline-block}.tag-container span{background:#f2f2f2;border-radius:6px;color:#5f5f5f;font-size:1rem;font-weight:400;margin:0 .5rem .5rem 0;padding:.3rem .5rem}.tag-container span .count{color:#5183f5;font-weight:700;margin-left:.25rem}.tag-container span:active,.tag-container span:focus,.tag-container span:hover{background:#e5e5e5;color:#454545}.tag-container.articles-page-tags{margin-bottom:1rem}@media(min-width:620px){.tag-container span{font-size:1rem;font-weight:500;padding:.3rem .8rem}.tag-container span .count{margin-left:.5rem}.tag-container.articles-page-tags{display:-ms-flexbox;display:flex;margin-bottom:2rem}.tag-container.articles-page-tags a{-ms-flex:1 1;flex:1 1}.tag-container.articles-page-tags a span{-ms-flex-pack:center;display:-ms-flexbox;display:flex;justify-content:center}}.post-meta{-ms-flex-align:center;align-items:center;color:rgba(0,0,0,.6);display:-ms-inline-flexbox;display:inline-flex;font-size:1.3rem}.post-meta .date{margin-right:.5rem}.post-meta a.comment-link,.post-meta a.github-link,.post-meta a.twitter-link{margin:0 .5rem}@media(min-width:620px){.post-meta{font-size:1.4rem}}blockquote{background:#fff4d5;border:2px solid #ffedbb;border-radius:6px;color:rgba(0,0,0,.8);font-size:1rem;font-weight:500;line-height:1.6;margin:1.5rem 0;padding:1.5rem}blockquote p{font-size:1.15rem;padding:0}blockquote p:last-child{margin-bottom:0}blockquote a{border-bottom:none!important;color:#111}blockquote a:active,blockquote a:focus,blockquote a:hover{background:#ffebb1!important;color:#111!important}blockquote code{margin:1rem 0 0}blockquote ul:last-of-type{margin-bottom:0}@media(min-width:620px){blockquote{padding:2rem}blockquote p{font-size:1.5rem}blockquote cite{font-size:2rem}}.search{margin-bottom:0}.filter-count{color:#2161f2;font-size:1.4rem;font-weight:500;text-align:center;width:80px}.emoji-in-button{font-size:1.5rem;line-height:0;margin-left:.75rem}.search-container{-ms-flex-align:center;align-items:center;display:-ms-flexbox;display:flex;margin-bottom:2rem}.category-container{-ms-flex-pack:start;display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;justify-content:flex-start;margin-bottom:1.5rem}.category-container .category-filter{-ms-flex-align:center;align-items:center;background:#ebf1fe;border-radius:6px;color:#2161f2;cursor:pointer;display:-ms-flexbox;display:flex;font-size:.85rem;font-weight:500;margin-bottom:.5rem;margin-right:.5rem;padding:.5rem .75rem}.category-container .category-filter .count{-ms-flex-align:center;-ms-flex-pack:center;align-items:center;border-radius:50%;color:#5183f5;display:-ms-flexbox;display:flex;font-size:.8rem;height:23px;justify-content:center;margin-left:1rem;padding:5px;width:23px}.category-container .category-filter.active{background:#5183f5;color:#fff}.category-container .category-filter.active .count{background:#fff}.category-container .category-filter.active:active,.category-container .category-filter.active:focus,.category-container .category-filter.active:hover{background:#2161f2;color:#fff}.category-container .category-filter:last-of-type{margin-right:0}.category-container .category-filter:hover{background:#d8e3fd;color:#3972f4}@media(min-width:620px){.category-container{margin-bottom:1.5rem}.category-container .category-filter{font-size:1rem;padding:.5rem 1rem}}.footer{-ms-flex-pack:justify;color:rgba(0,0,0,.6);-ms-flex-direction:column;flex-direction:column;justify-content:space-between;margin-top:2.5rem}.footer,.footer div{-ms-flex-align:center;align-items:center;display:-ms-flexbox;display:flex}.footer div{padding-bottom:1.5rem}.footer strong{margin-right:1rem}.footer a{color:rgba(0,0,0,.6);display:block;font-weight:400;margin-right:1.5rem}.footer a:hover{color:rgba(0,0,0,.8)}.footer .footer-img{height:30px;margin-bottom:0;width:30px}@media(min-width:620px){.footer{-ms-flex-direction:row;flex-direction:row;height:100px;margin:60px auto}}iframe{margin-bottom:0}[type=submit]:disabled,[type=submit]:disabled:active,[type=submit]:disabled:focus,[type=submit]:disabled:hover,button[disabled],button[disabled]:active,button[disabled]:focus,button[disabled]:hover{opacity:.5}::-moz-selection{background:rgba(255,235,20,.7);color:#111}::selection{background:rgba(255,235,20,.7);color:#111}@media print{.footer{display:none}}code{font-size:13px}pre.language-shell-session code.language-shell-session{background:#fff;border:1px solid #d8d9da;border-radius:6px;-webkit-box-shadow:3px 5px 20px rgba(0,0,0,.16);box-shadow:3px 5px 20px rgba(0,0,0,.16);color:#333;font-family:Menlo,Roboto Mono,Courier New,monospace;font-size:13px;margin:2rem 0;padding:45px 1rem 1rem;position:relative}pre.language-shell-session code.language-shell-session:before{background:#e1e1e1;color:#c2c3c4;content:"•••";font-size:2.5rem;height:25px;left:0;letter-spacing:-15px;line-height:0;margin:0;padding:14px 0;position:absolute;text-indent:4px;top:0;width:100%}code[class*=language-],pre code,pre[class*=language-]{-webkit-font-smoothing:subpixel-antialiased;border-radius:6px;color:#b3b9c5;direction:ltr;font-family:Menlo,Roboto Mono,Courier New,monospace;font-size:13px;font-weight:400;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.7;margin:2rem 0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;white-space:pre-wrap;word-break:normal;word-spacing:normal}pre code{background-color:#333;border:0;-webkit-box-shadow:2px 4px 25px rgba(0,0,0,.15);box-shadow:2px 4px 25px rgba(0,0,0,.15);display:block;overflow:auto;padding:1.5rem}kbd{background-color:#f7f7f7;border:2px solid rgba(0,0,0,.3);border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 2px #fff;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 2px #fff;color:#333;display:inline-block;font-family:Helvetica Neue,Roboto,-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif;font-size:14px;line-height:1.4;margin:0 .1em;padding:.1em .6em;text-shadow:0 1px 0 #fff}:not(pre)>code,:not(pre)>code[class*=language-]{color:#111;font-weight:500;padding:3px 5px}:not(pre)>code{background:rgba(0,0,0,.06);border:none;border-radius:4px;font-family:Menlo,Roboto Mono,Courier New,monospace}code[class*=language-css],code[class*=language-less],code[class*=language-sass],code[class*=language-scss]{color:#c9c}.filename{background:#111;border-top-left-radius:6px;border-top-right-radius:6px;color:#fff;font-size:1rem;font-weight:700;margin-bottom:-2.3rem;padding:.5rem 1rem .75rem}@media(min-width:620px){code,code[class*=language-],pre code,pre.language-shell-session code.language-shell-session,pre[class*=language-]{font-size:14px}}.token.doctype{background:#000;color:#fff}.token.cdata,.token.comment,.token.prolog{color:#848991}.token.namespace{opacity:.7}.token.attr-value,.token.string{color:#92d192}.token.punctuation{color:#d5d8df}.token.operator{color:#ac8d58}.token.variable{color:#f2777a}.token.property{color:#abb2bf}.token.builtin{color:#4a7baa}.token.parameter{color:#848991}.token.boolean,.token.constant{color:#e1a6f2}.token.entity,.token.inserted,.token.number,.token.regex,.token.symbol,.token.url{color:#fca369}.token.delimiter{background:#000;color:#fff;padding:1px 2px}.token.atrule{color:#62cfcf}.token.keyword{color:#ffeead}.language-autohotkey .token.selector{color:#fca369}.token.attr-name{color:#ffd479}.token.function{color:#62cfcf}.language-php .token.function{color:#fff}.token.class-name{color:#e1a6f2}.language-autohotkey .token.tag,.token.deleted{color:#f2777a}.token.tag{color:#6ab0f3}.language-autohotkey .token.keyword{color:#ffeead}.token.selector{color:#ffd479}.token.italic{font-style:italic}pre[data-line]{padding:1rem 0;position:relative}.line-highlight{background:hsla(0,0%,59%,.1);left:0;line-height:inherit;margin-top:1rem;padding-bottom:inherit;padding-left:0;padding-right:0;padding-top:inherit;pointer-events:none;position:absolute;right:0;white-space:pre}.line-highlight:before,.line-highlight[data-end]:after{background-color:transparent;border-radius:999px;color:transparent;content:attr(data-start);font:700 65%/1.5 sans-serif;left:.6em;min-width:1em;padding:0 .5em;position:absolute;text-align:center;text-shadow:none;top:.4em;vertical-align:.3em}.line-highlight[data-end]:after{bottom:.4em;content:attr(data-end);top:auto}.line-numbers .line-highlight:after,.line-numbers .line-highlight:before{content:none}code::-moz-selection,pre::-moz-selection{background:hsla(0,0%,59%,.3)!important;color:inherit;text-shadow:none}code::selection,pre::selection{background:hsla(0,0%,59%,.3)!important;color:inherit;text-shadow:none}code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:hsla(0,0%,59%,.3)!important;color:inherit;text-shadow:none}code[class*=language-] ::selection,pre[class*=language-]::selection{background:hsla(0,0%,59%,.3)!important;color:inherit;text-shadow:none}.gatsby-highlight-code-line{background-color:#191919;border-left:.25em solid #92d192;display:block;margin-left:-1em;margin-right:-1em;padding-left:.75em;padding-right:1em}.dark{background:#202020;color:#b3b9c5}.dark a{color:#6ab0f3}.dark a:active,.dark a:focus,.dark a:hover{background:transparent;color:#238aed}.dark .lead h1{color:#eee}.dark .lead a:not(.button):not(.anchor):not(.gatsby-resp-image-link){background:transparent!important;border-bottom:none}.dark .lead a:not(.button):not(.anchor):not(.gatsby-resp-image-link):hover{color:#238aed}.dark .page a:not(.button):not(.anchor):not(.gatsby-resp-image-link),.dark .page a:not(span.gatsby-resp-image-wrapper),.dark .post a:not(.button):not(.anchor):not(.gatsby-resp-image-link),.dark .post a:not(span.gatsby-resp-image-wrapper){border-bottom:2px solid transparent;padding:1px 2px}.dark .page a:not(.button):not(.anchor):not(.gatsby-resp-image-link):active,.dark .page a:not(.button):not(.anchor):not(.gatsby-resp-image-link):focus,.dark .page a:not(.button):not(.anchor):not(.gatsby-resp-image-link):hover,.dark .page a:not(span.gatsby-resp-image-wrapper):active,.dark .page a:not(span.gatsby-resp-image-wrapper):focus,.dark .page a:not(span.gatsby-resp-image-wrapper):hover,.dark .post a:not(.button):not(.anchor):not(.gatsby-resp-image-link):active,.dark .post a:not(.button):not(.anchor):not(.gatsby-resp-image-link):focus,.dark .post a:not(.button):not(.anchor):not(.gatsby-resp-image-link):hover,.dark .post a:not(span.gatsby-resp-image-wrapper):active,.dark .post a:not(span.gatsby-resp-image-wrapper):focus,.dark .post a:not(span.gatsby-resp-image-wrapper):hover{background:#3b97ef;border-radius:4px;color:#fff}.dark .page img,.dark .post img{height:auto;max-width:100%}.dark .page h2,.dark .post h2{border:none;color:#ffd479}.dark :not(pre)>code{background:hsla(0,0%,100%,.1);color:#b3b9c5}.dark .nav{background:#202020;border-color:#202020}.dark .nav.scroll{background:#131313;border-color:#131313}.dark .nav .brand a{color:#c1c6d0}.dark .nav .brand a:hover{color:#eee}.dark .nav .links a{color:#8891a4}.dark .nav .links a.active,.dark .nav .links a:hover{background:rgba(0,0,0,.2)}.dark .nav .links a:hover{color:#b3b9c5}.dark .nav .links a.active{color:#6ab0f3}.dark li,.dark ol,.dark p,.dark ul{color:#b3b9c5}.dark h2{border-color:#303030}.dark h1,.dark h2,.dark h3,.dark h4,.dark h5{color:#eee}.dark .posts.simple a .each{border-color:transparent transparent #181818}.dark .posts.simple a .each h2{color:#9fa3a9}.dark .posts.simple a .each:hover{background:#303030}.dark .posts a .each{border:1px solid transparent;border-bottom-color:#181818}.dark .posts a .each h2{color:#ccc}.dark .posts a .each:hover{background:#303030!important;border-color:#303030}.dark .posts a .each:hover h2{color:#fff}.dark .posts a .datetime{color:#848991}.dark .posts a .excerpt{color:hsla(0,0%,100%,.3)}.dark .tag-container span{background:rgba(0,0,0,.2);border:none;color:#b3b9c5}.dark .tag-container span .count{color:#ff5a5f}.dark .tag-container span:active,.dark .tag-container span:focus,.dark .tag-container span:hover{background:#111;border:none;color:#fff}.dark .post-meta{color:#848991}.dark th{border-bottom:2px solid #131313}.dark tfoot th{border-top:2px solid #0c0c0c}.dark td{border-bottom:2px solid #0c0c0c}.dark tbody tr:nth-child(2n){background-color:#2d2d2d}.dark pre code{background:#3a3a3a}.dark blockquote{background:rgba(0,0,0,.2);border:2px solid #393939}.dark blockquote p{color:#fed356}.dark blockquote a{border-bottom:#fed356!important;color:#fff4d5!important}.dark blockquote a:hover{background:#111!important;color:#febf0a!important}.dark blockquote.quotation{background:rgba(0,0,0,.2);border-color:#3a3a3a;-webkit-box-shadow:none;box-shadow:none;color:#fed356}.dark blockquote.quotation cite{color:#fff}.dark cite{color:hsla(0,0%,100%,.4)}.dark .footer,.dark .footer strong{color:#b3b9c5}.dark .footer a{color:#8891a4}.dark .footer a:hover{color:#d0d4db}.dark [type=color],.dark [type=date],.dark [type=email],.dark [type=number],.dark [type=search],.dark [type=text],.dark [type=url],.dark select,.dark textarea{background:#333!important;border:2px solid #444;color:#b3b9c5}.dark [type=color]:hover,.dark [type=date]:hover,.dark [type=email]:hover,.dark [type=number]:hover,.dark [type=search]:hover,.dark [type=text]:hover,.dark [type=url]:hover,.dark select:hover,.dark textarea:hover{border:2px solid #505050}.dark [type=color]:active,.dark [type=color]:focus,.dark [type=date]:active,.dark [type=date]:focus,.dark [type=email]:active,.dark [type=email]:focus,.dark [type=number]:active,.dark [type=number]:focus,.dark [type=search]:active,.dark [type=search]:focus,.dark [type=text]:active,.dark [type=text]:focus,.dark [type=url]:active,.dark [type=url]:focus,.dark select:active,.dark select:focus,.dark textarea:active,.dark textarea:focus{border:2px solid #6ab0f3}.dark .button,.dark [type=button],.dark [type=submit],.dark a.button,.dark button{background:#0f64b5!important;border:2px solid transparent;color:#fff}.dark .button:disabled,.dark [type=button]:disabled,.dark [type=submit]:disabled,.dark a.button:disabled,.dark button:disabled{cursor:default;opacity:.3;pointer-events:none}.dark .button:active,.dark .button:focus,.dark .button:hover,.dark [type=button]:active,.dark [type=button]:focus,.dark [type=button]:hover,.dark [type=submit]:active,.dark [type=submit]:focus,.dark [type=submit]:hover,.dark a.button:active,.dark a.button:focus,.dark a.button:hover,.dark button:active,.dark button:focus,.dark button:hover{background:#127ee5!important;border:2px solid transparent;color:#fff}.dark .new,.dark .popular{background:rgba(0,0,0,.2)}.dark .popular{color:#92d192}.dark .button.muted-button,.dark a.button.muted-bottom{border:2px solid #848991;color:#848991}.dark .button.muted-button:active,.dark .button.muted-button:focus,.dark .button.muted-button:hover,.dark a.button.muted-bottom:active,.dark a.button.muted-bottom:focus,.dark a.button.muted-bottom:hover{background:transparent;border:2px solid #b3b9c5;color:#b3b9c5}.dark button.dark-switcher{background:transparent!important;border:none!important}.dark pre.language-shell-session code.language-shell-session{background:#111;border:2px solid #666;color:#ccc}.dark pre.language-shell-session code.language-shell-session:before{background:#303030;color:#888}.dark .category-container .category-filter{background:rgba(0,0,0,.2);color:#6ab0f3;cursor:pointer;font-weight:500}.dark .category-container .category-filter.active{background:#6ab0f3!important;color:#fff!important}.dark .category-container .category-filter:last-of-type{margin-right:0}.dark .category-container .category-filter:hover{background:#111;color:#99c9f7}.dark .filter-count{color:#6ab0f3}.dark mark{background:#127ee5;color:#fff}.dark ::-moz-selection{background:#6ab0f3;color:#fff}.dark ::selection{background:#6ab0f3;color:#fff}.dark path{stroke:#ffeead}.dark .github-nav-icon{color:#fff}.not-found{background:#000084;color:#bbb;font-family:PerfectDOS,Courier New,monospace;font-size:16px;font-weight:400;height:100vh}.not-found #main-content{margin:0;padding-top:80px}.not-found button.dark-switcher,.not-found footer.footer{display:none}.not-found h1{background:#bbb;-webkit-box-shadow:10px 10px 0 #000;box-shadow:10px 10px 0 #000;color:#000;display:inline-block;font-family:PerfectDOS,Courier New,monospace;font-weight:600;margin-bottom:40px;padding:10px 20px}.not-found p{font-size:16px}.not-found .list p:not(:last-of-type){margin-bottom:5px}.not-found .bullet{margin-right:30px}.not-found .error-msg{color:#ff0}.not-found .nav{background:#bbb;border-bottom:2px solid #bbb;color:#000;height:30px}.not-found .nav .nav-container{height:30px;padding:0}.not-found .nav .nav-container .brand{-ms-flex-align:center;align-items:center;display:-ms-flexbox;display:flex}.not-found .nav .nav-container .brand,.not-found .nav .nav-container .brand a,.not-found .nav .nav-container .links{height:30px}.not-found .nav .nav-container .brand a,.not-found .nav .nav-container .links a{border-radius:0;color:#000;font-size:16px;font-weight:600;line-height:30px;margin:0;padding:0 5px}.not-found .nav .nav-container .brand a:active,.not-found .nav .nav-container .brand a:focus,.not-found .nav .nav-container .brand a:hover,.not-found .nav .nav-container .links a:active,.not-found .nav .nav-container .links a:focus,.not-found .nav .nav-container .links a:hover{background:#000;color:#bbb}.not-found .nav .nav-container a.kofi-button{background:#0aa;border:none;border-radius:0;color:#eee;display:none;height:30px}.not-found .nav .nav-container a.kofi-button:active,.not-found .nav .nav-container a.kofi-button:focus,.not-found .nav .nav-container a.kofi-button:hover{background:#000;border:none;color:#fff}@media(min-width:900px){.not-found{font-size:24px}.not-found #main-content{padding-top:160px}.not-found .nav .nav-container .brand a,.not-found .nav .nav-container .links a{font-size:24px;padding:0 15px}.not-found p{font-size:24px}.not-found .emoji,.not-found img{display:none}}.blink{-webkit-animation:blinkingText .8s infinite;animation:blinkingText .8s infinite}@-webkit-keyframes blinkingText{0%{opacity:0}49%{opacity:0}50%{opacity:1}}@keyframes blinkingText{0%{opacity:0}49%{opacity:0}50%{opacity:1}}.twitter-tweet{margin-bottom:2rem!important;margin-top:0!important}</style><title data-react-helmet="true">Déployer son infra K3S sur Proxmox en mode IaC – Beerus blog</title><link data-react-helmet="true" rel="icon" type="image/png" href="/static/favicon-256-f20245a369a5ff9292f43e7bc768bc62.png"/><script data-react-helmet="true" type="application/ld+json">[{"@context":"http://schema.org","@type":"WebSite","url":"https://blog.beerus.fr/","name":"Déployer son infra K3S sur Proxmox en mode IaC","alternateName":"Beerus blog"},{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.beerus.fr/deploy-k3s-proxmox","name":"Déployer son infra K3S sur Proxmox en mode IaC","image":"https://blog.beerus.fr/static/9ea3747d497ad41230fd09f582184574/thumbnail.svg"}}]},{"@context":"http://schema.org","@type":"BlogPosting","url":"https://blog.beerus.fr/","name":"Déployer son infra K3S sur Proxmox en mode IaC","alternateName":"Beerus blog","headline":"Déployer son infra K3S sur Proxmox en mode IaC","image":{"@type":"ImageObject","url":"https://blog.beerus.fr/static/9ea3747d497ad41230fd09f582184574/thumbnail.svg"},"description":"Architecture Je suis en train de préparer la Certified Kubernetes Administrator (CKA) et il me faudrait un lab pour m'exercer. J'ai pas mal…"}]</script><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 100)
          }), 0)
        }
      }
    })
  </script><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/favicon/favicon-48.png"/><link rel="apple-touch-icon" sizes="1024x1024" href="/favicon/favicon-1024.png"/><link rel="alternate" type="application/rss+xml" title="Beerus Inc. - RSS Feed" href="/rss.xml"/></head><body class="theme dark"><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="nav"><div class="nav-container"><div class="brand"><a href="/"><img src="/static/avatar-8c427968a9e9b833cce13fc74e7b3f88.png" class="favicon" alt="Avatar"/><span class="text">Beerus Inc.</span></a></div><div class="links"><a href="https://github.com/ramuskay"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" class="nav-icons github-nav-icon" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="https://twitter.com/retyyuiop"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="nav-icons twitter-nav-icon" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://photos.beerus.fr"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="nav-icons camera-nav-icon" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title>Photos</title><path d="M512 144v288c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V144c0-26.5 21.5-48 48-48h88l12.3-32.9c7-18.7 24.9-31.1 44.9-31.1h125.5c20 0 37.9 12.4 44.9 31.1L376 96h88c26.5 0 48 21.5 48 48zM376 288c0-66.2-53.8-120-120-120s-120 53.8-120 120 53.8 120 120 120 120-53.8 120-120zm-32 0c0 48.5-39.5 88-88 88s-88-39.5-88-88 39.5-88 88-88 88 39.5 88 88z"></path></svg></a><div class="cta"><button class="dark-switcher" aria-label="Toggle Light/Dark Mode." title="Toggle Light/Dark Mode"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="nav-icons sun-nav-icon" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M277.3 32h-42.7v64h42.7V32zm129.1 43.7L368 114.1l29.9 29.9 38.4-38.4-29.9-29.9zm-300.8 0l-29.9 29.9 38.4 38.4 29.9-29.9-38.4-38.4zM256 128c-70.4 0-128 57.6-128 128s57.6 128 128 128 128-57.6 128-128-57.6-128-128-128zm224 106.7h-64v42.7h64v-42.7zm-384 0H32v42.7h64v-42.7zM397.9 368L368 397.9l38.4 38.4 29.9-29.9-38.4-38.4zm-283.8 0l-38.4 38.4 29.9 29.9 38.4-38.4-29.9-29.9zm163.2 48h-42.7v64h42.7v-64z"></path></svg></button></div></div></div></nav><main id="main-content"><article class="single container"><header class="single-header "><div class="gatsby-image-wrapper"><img src="/static/9ea3747d497ad41230fd09f582184574/thumbnail.svg" alt=""/></div><div class="flex"><h1>Déployer son infra K3S sur Proxmox en mode IaC</h1><div class="post-meta"><time class="date">19 July, 2022</time>/<!-- --><a class="github-link" href="https://github.com/ramuskay/blog-beerus/edit/master/posts/2022/2022-07-19-deploy-k3s-proxmox/index.md" target="_blank" rel="noopener noreferrer">Edit</a></div><div class="post-meta"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10">null</circle><polyline points="12 6 12 12 16 14">null</polyline></svg>  <!-- -->13<!-- --> min read.<!-- --></div><div class="tag-container"><a style="text-decoration:none" href="/tags/k-3-s/"><span>k3s</span></a><a style="text-decoration:none" href="/tags/hashicorp/"><span>hashicorp</span></a><a style="text-decoration:none" href="/tags/packer/"><span>packer</span></a><a style="text-decoration:none" href="/tags/terraform/"><span>terraform</span></a><a style="text-decoration:none" href="/tags/proxmox/"><span>proxmox</span></a></div></div></header><div class="post"><h1 id="architecture" style="position:relative;"><a href="#architecture" aria-label="architecture permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Architecture</h1>
<p>Je suis en train de préparer la Certified Kubernetes Administrator (CKA) et il me faudrait un lab pour m'exercer. J'ai pas mal fait de Kubernetes classique en lab via des formations Udemy et j'aimerai tester autre chose mais toujours sur une base K8S.
Je me suis penché sur K3S de Rancher. Il dispose de plusieurs qualités qui me semble intéressantes :</p>
<ul>
<li>Il est léger et plus rapide que K8s</li>
<li>Il peut s'exécuter sur du plus petit matériel (proc ARM par ex 🥰). J'ai comme projet potentiel de faire un cluster de raspberry donc K3S est plus qu'indiqué.</li>
<li>Il ne dispose pas de tous les connecteurs cloud mais vu que ça sera du "on premise" dans mon cas c'est parfait.</li>
<li>Plein de petits avantages : + facile et rapide à déployer, moins de surface d'attaque, facile à update etc...</li>
</ul>
<p>Par contre il ne fait pas tourner docker nativement mais containerd (bien que j'ai vu un projet passer s'appelant k3d qui intègre docker), ça sera l'occasion d'apprendre autre chose surtout que le CRI (Container Runtime Interface) en soi n'est pas le plus important.</p>
<p>Une fois mon choix d'orchestrateur choisi je me suis dit que j'allais installer mon cluster K3s sur mon lab maison qui exécute un Proxmox et tant qu'à faire autant avoir un workflow de déploiement un peu évolué pour s'exercer.</p>
<p>Parmi toutes les ressources que j'ai pu voir le workflow qui me semblait au départ le plus intéressant faisait les choses suivantes :</p>
<ul>
<li>Récupération de l'ISO Ubuntu 20 sur Proxmox</li>
<li>Création du template Proxmox "à la main" via des commandes qm (cli proxmox)</li>
<li>Configuration de cloud init via l'onglet promox dédié</li>
<li>Création des VM via Terraform</li>
<li>Ansible pour déployer K3s sur mes nouvelles VM</li>
</ul>
<p>Cela paraissait sympa sur le papier et puis ça permettait de mettre en application les quelques connaissances Terraform dont je disposais.
Mais à bien réfléchir il y avait quand même deux problèmes dans ce process :</p>
<ul>
<li>Une partie manuelle qui cassait un peu l'automatisation voulue. Si je pouvais automatiser cela je serais vraiment dans un cas d'IaC (<strong>Infra As Code</strong>)</li>
<li>Pas très flexible car si je veux customiser mon template ça sera à la main aussi ou à la limite via script bash</li>
</ul>
<p>C'est là que je suis tombé sur un autre outil d'Hashicorp qui fait tout ce travail manuel pour moi et dispose de la flexibilité voulue : Packer !</p>
<p></br>Voici les deux workflows qui sont ressortis au final :</p>
<ul>
<li>Création du template --> Cloud init --> Terraform --> Ansible --> K3S</li>
<li><strong>Packer (+Cloud init) --> Terraform --> Ansible --> K3S</strong></li>
</ul>
<p>J'ai donc choisi le deuxième worflow<br>
Avantages :</p>
<ul>
<li>Infra as code - Full automatisée</li>
<li>Pas d'interaction directe avec Proxmox, seulement via son API</li>
<li>Peut donc être piloté depuis une machine tierce</li>
</ul>
<p>⚠️ Inconvénients :</p>
<ul>
<li>Nécessite plus de développement et de temps pour un résultat équivalent dans mon cas (installation d'un potentiel DHCP, création du fichier de conf packer etc...)</li>
<li>Temps d'exécution de création du template plus long</li>
</ul>
<p>Retrouver l'ensemble du projet sur ce git : <a href="https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer">https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer</a></p>
<h1 id="packer" style="position:relative;"><a href="#packer" aria-label="packer permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Packer</h1>
<p>Je vais donc utiliser packer pour packager mon image Ubuntu 20.04 avec quelques packages et confs additionnelles. Il suffit d'installer <a href="https://www.packer.io/downloads">packer</a> puis nous verrons les fichiers de configuration.<br>
D'ailleurs dans mon cas pas besoin de DHCP, celui de ma box avec ma VM template en mode bridge sera largement suffisant.<br>
Voici mon arborescence packer pour la config :</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">├── http
│   ├── meta-data
│   └── user-data
├── ubuntu20.pkr.hcl
└── variables.pkr.hcl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Les fichiers de conf peuvent être en json ou HCL (format hashicorp), j'ai choisi HCL à la place de JSON pour deux raisons :</p>
<ul>
<li>Langage commun avec tous les outils HashiCorp (vu qu'on va aussi utiliser Terraform ça a du sens)</li>
<li>Plus "fonctionnel", on peut par exemple mettre des commentaires (dans JSON non ça fera toujours partie de la data)</li>
</ul>
<p>On a donc 2 fichiers hcl concernant :</p>
<ul>
<li><code class="language-text">variables.pkr.hcl</code> : la définition des variables par défaut</li>
<li><code class="language-text">ubuntu20.pkr.hcl</code> : la définition du job packer</li>
</ul>
<p>Regardons plus en détail <code class="language-text">ubuntu20.pkr.hcl</code> :</p>
<div class="gatsby-highlight" data-language="ruby"><pre style="counter-reset: linenumber NaN" class="language-ruby line-numbers"><code class="language-ruby">source <span class="token string-literal"><span class="token string">"proxmox"</span></span> <span class="token string-literal"><span class="token string">"template"</span></span> <span class="token punctuation">{</span>
  proxmox_url <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${var.proxmox_hostname}/api2/json"</span></span>
  username <span class="token operator">=</span> var<span class="token punctuation">.</span>proxmox_username
  password <span class="token operator">=</span> var<span class="token punctuation">.</span>proxmox_password
  node <span class="token operator">=</span> var<span class="token punctuation">.</span>proxmox_node_name
  insecure_skip_tls_verify <span class="token operator">=</span> var<span class="token punctuation">.</span>proxmox_insecure_skip_tls_verify
  network_adapters <span class="token punctuation">{</span>
    bridge <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"vmbr0"</span></span>
  <span class="token punctuation">}</span>
  disks <span class="token punctuation">{</span>
    type <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"scsi"</span></span>
    disk_size <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"20G"</span></span>
    storage_pool <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_storage_pool
    storage_pool_type <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"lvm"</span></span>
  <span class="token punctuation">}</span>
  <span class="token comment">#iso_file = "local:iso/ubuntu-20.04.4-live-server-amd64.iso"</span>
  iso_url               <span class="token operator">=</span> var<span class="token punctuation">.</span>iso_url
  iso_storage_pool      <span class="token operator">=</span> var<span class="token punctuation">.</span>iso_storage_pool
  iso_checksum          <span class="token operator">=</span> var<span class="token punctuation">.</span>iso_checksum
  unmount_iso <span class="token operator">=</span> <span class="token boolean">true</span>
  boot_wait <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"5s"</span></span>
  memory <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_memory
  sockets   <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_sockets
  cores     <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_cores
  template_name <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_name
  vm_id     <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_id
  http_directory <span class="token operator">=</span> var<span class="token punctuation">.</span>http_directory
  cloud_init <span class="token operator">=</span> <span class="token boolean">true</span>
  cloud_init_storage_pool <span class="token operator">=</span> var<span class="token punctuation">.</span>iso_storage_pool
  boot_command <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string-literal"><span class="token string">"&lt;esc>&lt;wait>&lt;esc>&lt;wait>&lt;f6>&lt;wait>&lt;esc>&lt;wait>"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"&lt;bs>&lt;bs>&lt;bs>&lt;bs>&lt;bs>"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"autoinstall ds=nocloud-net;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ "</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">"--- &lt;enter>"</span></span>
  <span class="token punctuation">]</span>
  ssh_username <span class="token operator">=</span> var<span class="token punctuation">.</span>username
  ssh_password <span class="token operator">=</span> var<span class="token punctuation">.</span>user_password
  ssh_timeout <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"20m"</span></span>
<span class="token punctuation">}</span>

build <span class="token punctuation">{</span>
  sources <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string-literal"><span class="token string">"source.proxmox.template"</span></span>
  <span class="token punctuation">]</span>
  provisioner <span class="token string-literal"><span class="token string">"shell"</span></span> <span class="token punctuation">{</span>
    inline <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string-literal"><span class="token string">"sudo rm -f /etc/cloud/cloud.cfg.d/99-installer.cfg"</span></span><span class="token punctuation">,</span>
      <span class="token string-literal"><span class="token string">"sudo rm -f /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg"</span></span><span class="token punctuation">,</span>
      <span class="token string-literal"><span class="token string">"sudo cloud-init clean"</span></span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Rien de bien compliqué là-dedans c'est aussi l'avantage en général des outils Hashicorp la configuration est très descriptive et donc compréhensible rapidement.
On va renseigner les informations suivantes :</p>
<ul>
<li>Des credentials pour le proxmox</li>
<li>Un peu de hardware pour le template (RAM, CPU, Disk etc...)</li>
<li>Une config pour le template (ID, nom, boot command , ssh cred etc...)</li>
<li>Un dossier pour la conf subiquity</li>
<li><strong>On active cloud-init car sinon on ne peut pas set les IP via Terraform</strong></li>
<li>On tweak un peu l'image car on veut qu'elle soit cloud-init ready</li>
</ul>
<p>Justement concernant autoinstall depuis la version 20.04 preseed a été délaissé au profit de subiquity qui est (de mon point de vue) bien plus facile à utiliser car format yaml et s'intègre très bien avec Packer. Ce qui donne deux fichiers :</p>
<ul>
<li><code class="language-text">meta-data</code> : requis. Utilisé par le cloud vu qu'on déploit en local on le laisse vide</li>
<li><code class="language-text">user-data</code> : l'équivalent du preseed, utilise autoinstall</li>
</ul>
<p>Le fichier <code class="language-text">user-data</code> en détail :</p>
<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token comment">#cloud-config</span>
<span class="token key atrule">autoinstall</span><span class="token punctuation">:</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">locale</span><span class="token punctuation">:</span> en_US
  <span class="token key atrule">keyboard</span><span class="token punctuation">:</span>
    <span class="token key atrule">layout</span><span class="token punctuation">:</span> fr
  <span class="token key atrule">ssh</span><span class="token punctuation">:</span>
    <span class="token key atrule">install-server</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">allow-pw</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">packages</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> qemu<span class="token punctuation">-</span>guest<span class="token punctuation">-</span>agent
  <span class="token key atrule">user-data</span><span class="token punctuation">:</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> canadium
          <span class="token key atrule">passwd</span><span class="token punctuation">:</span> $6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0
          <span class="token key atrule">groups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>adm<span class="token punctuation">,</span> cdrom<span class="token punctuation">,</span> dip<span class="token punctuation">,</span> plugdev<span class="token punctuation">,</span> sudo<span class="token punctuation">]</span>
          <span class="token key atrule">lock-passwd</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">sudo</span><span class="token punctuation">:</span> ALL=(ALL) NOPASSWD<span class="token punctuation">:</span>ALL
          <span class="token key atrule">shell</span><span class="token punctuation">:</span> /bin/bash
          <span class="token key atrule">ssh_authorized_keys</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJEXrwiuUOCpWPvwOsGuF4K+aq1ufToGMi4ra/1omOZb</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Fichier de configuration ultra basique, on définit un seul user et deux confs pour le système. Les autres options peuvent être trouvées dans la <a href="https://ubuntu.com/server/docs/install/autoinstall-reference">doc</a><br>
⚠️ Ce fichier est "templatiser" et redéfini via Terraform voir plus bas</p>
<p>On peut ensuite exécuter packer via Terraform pour avoir une seule et même exécution<br>
Ce qui nous donne un template de qualité !
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 850px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/cc6a97ebfa97429c534052f94c048994/d8a90/template-proxmox.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 44.131455399061025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA20lEQVQoz5WQy26DMBRE/f+/1nV3lNC4bkgwL2NjHoapxhKIRdSEkUawuPd45oqLzJGpB+73AnVZoqkbFEUB33tQ67qesvj4/EJyq9FPAXNYopdlQQgB0zRhnueX3ua4I26/Cs4adK7HjzbQTYfBe/gTHoZh/4o0TaHLEuM4Ql6/Ybtur/qumIxnYlKhlELbtpF+yTIYY3bYOzejeCLus7ZIkgRa60jnv5QyvngGyLoMxpYiz3NUVRXp22vHhP/pOMc9WpDunIsJnw2/0nEuAq21oDfgscqZhBvwD9YwwWrhe2wrAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="template proxmox"
        title="template proxmox"
        src="/static/cc6a97ebfa97429c534052f94c048994/d6170/template-proxmox.png"
        srcset="/static/cc6a97ebfa97429c534052f94c048994/53f68/template-proxmox.png 213w,
/static/cc6a97ebfa97429c534052f94c048994/df70d/template-proxmox.png 425w,
/static/cc6a97ebfa97429c534052f94c048994/d6170/template-proxmox.png 850w,
/static/cc6a97ebfa97429c534052f94c048994/d8a90/template-proxmox.png 920w"
        sizes="(max-width: 850px) 100vw, 850px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h1 id="terraform" style="position:relative;"><a href="#terraform" aria-label="terraform permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Terraform</h1>
<p>Il faut maintenant déployer notre template sous forme de VM, on va utiliser Terraform pour qui sera notre outil principal. <strong>Tout</strong> passera par Terraform :</p>
<ul>
<li>La création de fichier de conf pour Packer, Ansible et Terraform</li>
<li>L'exécution de Packer</li>
<li>L'exécution de Terraform bien sûr</li>
<li>L'exécution d'Ansible</li>
</ul>
<p>On installe <a href="https://learn.hashicorp.com/tutorials/terraform/install-cli?in=terraform/aws-get-started">Terraform</a> puis on s'attaque aux fichiers de configuration :</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">├── main.tf
├── output.tf
├── provider.tf
├── terraform.tfvars
└── variables.tf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Listons les fichiers Terraform :</p>
<ul>
<li><code class="language-text">main.tf</code> : On décrit notre déploiement, le fichier de job.</li>
<li><code class="language-text">output.tf</code> : La sortie voulue lors de l'exécution de Terraform apply (on va print les IP ici)</li>
<li><code class="language-text">provider.tf</code> : On précise quel provider on utilise, ici proxmox. (voir <a href="https://registry.terraform.io/providers/Telmate/proxmox/latest/docs">doc</a>)</li>
<li><code class="language-text">terraform.tfvars</code> : la définition des variables pour le main.tf (même principe que Packer)</li>
<li><code class="language-text">variables.tf</code> : la définition des variables par défaut (même principe que Packer)</li>
</ul>
<p>Et on a des fichiers de template qui vont nous permettre de définir notre inventory ansible, groups_vars ansible, user-data de autoinstall etc...</p>
<p>Je vais juste décrire le fichier main.tf car les autres sont plutôt évident.
On définit les variables pour l'exécution future de packer :</p>
<div class="gatsby-highlight" data-language="ruby"><pre style="counter-reset: linenumber NaN" class="language-ruby line-numbers"><code class="language-ruby">locals <span class="token punctuation">{</span>
  template_folder <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${path.module}/${var.folder_packer}/${var.distrib_folder}"</span></span>
  packer_cfg <span class="token operator">=</span> <span class="token punctuation">{</span>
    PKR_VAR_proxmox_hostname  <span class="token operator">=</span> var<span class="token punctuation">.</span>pm_host
    PKR_VAR_proxmox_username  <span class="token operator">=</span> var<span class="token punctuation">.</span>pm_user
    PKR_VAR_proxmox_password  <span class="token operator">=</span> var<span class="token punctuation">.</span>pm_password
    PKR_VAR_proxmox_node_name <span class="token operator">=</span> var<span class="token punctuation">.</span>pm_node_name
    PKR_VAR_proxmox_insecure_skip_tls_verify <span class="token operator">=</span> var<span class="token punctuation">.</span>pm_tls_insecure

    PKR_VAR_vm_id                 <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_id
    PKR_VAR_vm_name               <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_name
    PKR_VAR_vm_storage_pool       <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_storage_pool
    PKR_VAR_vm_cores              <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_cores
    PKR_VAR_vm_memory             <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_memory
    PKR_VAR_vm_sockets            <span class="token operator">=</span> var<span class="token punctuation">.</span>vm_sockets

    PKR_VAR_iso_url             <span class="token operator">=</span> var<span class="token punctuation">.</span>iso_url
    PKR_VAR_iso_storage_pool    <span class="token operator">=</span> var<span class="token punctuation">.</span>iso_storage_pool
    PKR_VAR_iso_checksum        <span class="token operator">=</span> var<span class="token punctuation">.</span>iso_checksum

    PKR_VAR_http_directory      <span class="token operator">=</span> var<span class="token punctuation">.</span>http_directory

    PKR_VAR_username              <span class="token operator">=</span> var<span class="token punctuation">.</span>username
    PKR_VAR_user_password         <span class="token operator">=</span> var<span class="token punctuation">.</span>user_password
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Ici justement on définit le job packer avec l'ensemble des paramètres souhaités (au final c'est une exécution shell classique).<br>
J'ai ajouté un petit sleep car parfois le template n'était pas prêt pour l'exécution Terraform. Également un script python pour supprimer le template créé par Packer (pas de ressource native donc obligé de "hack") :</p>
<div class="gatsby-highlight" data-language="ruby"><pre style="counter-reset: linenumber NaN" class="language-ruby line-numbers"><code class="language-ruby">resource <span class="token string-literal"><span class="token string">"null_resource"</span></span> <span class="token string-literal"><span class="token string">"packer_build"</span></span> <span class="token punctuation">{</span>
    provisioner <span class="token string-literal"><span class="token string">"local-exec"</span></span> <span class="token punctuation">{</span>
    working_dir <span class="token operator">=</span> local<span class="token punctuation">.</span>template_folder
    command     <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"packer build . &amp;&amp; sleep 30"</span></span>
    environment <span class="token operator">=</span> local<span class="token punctuation">.</span>packer_cfg
  <span class="token punctuation">}</span>
  provisioner <span class="token string-literal"><span class="token string">"local-exec"</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">when</span>  <span class="token operator">=</span> destroy
    command <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${path.module}/scripts/delete_template.py"</span></span>
    interpreter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"python"</span></span><span class="token punctuation">]</span>
    working_dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token keyword">module</span>
    <span class="token class-name">environment</span> <span class="token operator">=</span> merge<span class="token punctuation">(</span>yamldecode<span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>triggers<span class="token punctuation">.</span>packer_cfg<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    triggers <span class="token operator">=</span> <span class="token punctuation">{</span>
    packer_cfg <span class="token operator">=</span> yamlencode<span class="token punctuation">(</span>local<span class="token punctuation">.</span>packer_cfg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>
    local_file<span class="token punctuation">.</span>user<span class="token operator">-</span>data
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>On redéfinit un master K3S par-dessus notre template (var.tamplate_vm_name), on remarque qu'on doit préciser une dépendance pour que les tâches s'exécutent dans le bon ordre. A noter aussi un script sh qui vérifiera que le déploiement cloud-init est bien fini sur le serveur :</p>
<div class="gatsby-highlight" data-language="ruby"><pre style="counter-reset: linenumber NaN" class="language-ruby line-numbers"><code class="language-ruby">resource <span class="token string-literal"><span class="token string">"proxmox_vm_qemu"</span></span> <span class="token string-literal"><span class="token string">"proxmox_vm_master"</span></span> <span class="token punctuation">{</span>
  count       <span class="token operator">=</span> var<span class="token punctuation">.</span>num_k3s_masters
  name        <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"k3s-master-${count.index}"</span></span>
  target_node <span class="token operator">=</span> var<span class="token punctuation">.</span>pm_node_name
  clone       <span class="token operator">=</span> var<span class="token punctuation">.</span>template_vm_name
  os_type     <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"cloud-init"</span></span>
  agent       <span class="token operator">=</span> <span class="token number">1</span>
  memory      <span class="token operator">=</span> var<span class="token punctuation">.</span>num_k3s_masters_mem
  cores       <span class="token operator">=</span> var<span class="token punctuation">.</span>num_k3s_masters_cpu

  ipconfig0 <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"ip=${var.master_ips[count.index]}/${var.networkrange},gw=${var.gateway}"</span></span>

  lifecycle <span class="token punctuation">{</span>
    ignore_changes <span class="token operator">=</span> <span class="token punctuation">[</span>
      ciuser<span class="token punctuation">,</span>
      sshkeys<span class="token punctuation">,</span>
      disk<span class="token punctuation">,</span>
      desc<span class="token punctuation">,</span>
      network
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  connection <span class="token punctuation">{</span>
    type <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"ssh"</span></span>
    user <span class="token operator">=</span> var<span class="token punctuation">.</span>username
    password <span class="token operator">=</span> var<span class="token punctuation">.</span>user_password
    host <span class="token operator">=</span> var<span class="token punctuation">.</span>worker_ips<span class="token punctuation">[</span>count<span class="token punctuation">.</span>index<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  provisioner <span class="token string-literal"><span class="token string">"file"</span></span> <span class="token punctuation">{</span>
    source      <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${path.module}/scripts/wait-cloud-init.sh"</span></span>
    destination <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"/tmp/wait-cloud-init.sh"</span></span>
  <span class="token punctuation">}</span>

  provisioner <span class="token string-literal"><span class="token string">"remote-exec"</span></span> <span class="token punctuation">{</span>
    inline <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string-literal"><span class="token string">"chmod +x /tmp/wait-cloud-init.sh"</span></span><span class="token punctuation">,</span>
      <span class="token string-literal"><span class="token string">"/tmp/wait-cloud-init.sh"</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>
    null_resource<span class="token punctuation">.</span>packer_build
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>On fera la même tâche pour les workers</p>
<p>Et ici on définit nos tâches de customisation de conf, c'est à dire :</p>
<ul>
<li>Générer des fichiers de configuration pour la future exécution d'ansible</li>
<li>Générer le user-data nécessaire à l'autoinstall de packer (on modifie essentiellement le user/password)</li>
</ul>
<div class="gatsby-highlight" data-language="ruby"><pre style="counter-reset: linenumber NaN" class="language-ruby line-numbers"><code class="language-ruby">data <span class="token string-literal"><span class="token string">"template_file"</span></span> <span class="token string-literal"><span class="token string">"cloud-init-user-data"</span></span> <span class="token punctuation">{</span>
    template <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${file("</span></span>$<span class="token punctuation">{</span>path<span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">}</span><span class="token operator">/</span>templates<span class="token operator">/</span>user<span class="token operator">-</span>data<span class="token punctuation">.</span>tpl<span class="token string-literal"><span class="token string">")}"</span></span>
    vars <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token constant">SUDO_PASSWORD_HASH</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${var.user_password_hash}"</span></span>
        <span class="token constant">SUDO_USERNAME</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${var.username}"</span></span>
        <span class="token constant">SSH_PUBLIC_KEY</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${var.ssh_pub_key}"</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
resource <span class="token string-literal"><span class="token string">"local_file"</span></span> <span class="token string-literal"><span class="token string">"user-data"</span></span> <span class="token punctuation">{</span>
    content     <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${data.template_file.cloud-init-user-data.rendered}"</span></span>
    filename <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${local.template_folder}/http/user-data"</span></span>
<span class="token punctuation">}</span>

data <span class="token string-literal"><span class="token string">"template_file"</span></span> <span class="token string-literal"><span class="token string">"k8s"</span></span> <span class="token punctuation">{</span>
  template <span class="token operator">=</span> file<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"./templates/k8s.tpl"</span></span><span class="token punctuation">)</span>
  vars <span class="token operator">=</span> <span class="token punctuation">{</span>
    k3s_master_ip <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${join("</span></span>\n<span class="token string-literal"><span class="token string">", [for instance in proxmox_vm_qemu.proxmox_vm_master : join("</span></span><span class="token string-literal"><span class="token string">", [instance.default_ipv4_address, "</span></span> ansible_ssh_private_key_file<span class="token operator">=</span><span class="token string-literal"><span class="token string">", var.pvt_key])])}"</span></span>
    k3s_node_ip   <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${join("</span></span>\n<span class="token string-literal"><span class="token string">", [for instance in proxmox_vm_qemu.proxmox_vm_workers : join("</span></span><span class="token string-literal"><span class="token string">", [instance.default_ipv4_address, "</span></span> ansible_ssh_private_key_file<span class="token operator">=</span><span class="token string-literal"><span class="token string">", var.pvt_key])])}"</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

resource <span class="token string-literal"><span class="token string">"local_file"</span></span> <span class="token string-literal"><span class="token string">"k8s_file"</span></span> <span class="token punctuation">{</span>
  content  <span class="token operator">=</span> data<span class="token punctuation">.</span>template_file<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>rendered
  filename <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${path.module}/ansible/hosts"</span></span>
<span class="token punctuation">}</span>

data <span class="token string-literal"><span class="token string">"template_file"</span></span> <span class="token string-literal"><span class="token string">"groups_vars_ansible"</span></span> <span class="token punctuation">{</span>
    template <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${file("</span></span>$<span class="token punctuation">{</span>path<span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">}</span><span class="token operator">/</span>templates<span class="token operator">/</span>all<span class="token punctuation">.</span>tpl<span class="token string-literal"><span class="token string">")}"</span></span>
    vars <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token constant">ANSIBLE_USER</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${var.username}"</span></span>
        <span class="token constant">K3S_VERSION</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${var.k3s_version}"</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

resource <span class="token string-literal"><span class="token string">"local_file"</span></span> <span class="token string-literal"><span class="token string">"groups_vars_ansible"</span></span> <span class="token punctuation">{</span>
    content     <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${data.template_file.groups_vars_ansible.rendered}"</span></span>
    filename <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"${path.module}/ansible/group_vars/all.yml"</span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Et enfin le job ansible :</p>
<div class="gatsby-highlight" data-language="ruby"><pre style="counter-reset: linenumber NaN" class="language-ruby line-numbers"><code class="language-ruby">resource <span class="token string-literal"><span class="token string">"null_resource"</span></span> <span class="token string-literal"><span class="token string">"ansible-playbook"</span></span> <span class="token punctuation">{</span>
  provisioner <span class="token string-literal"><span class="token string">"local-exec"</span></span> <span class="token punctuation">{</span>
    command <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"ansible-playbook -i ${var.inventory_file}  --private-key ${var.ssh_key_file} site.yml"</span></span>
    working_dir <span class="token operator">=</span> <span class="token string-literal"><span class="token string">".."</span></span>
  <span class="token punctuation">}</span>
  depends_on <span class="token operator">=</span> <span class="token punctuation">[</span>
    proxmox_vm_qemu<span class="token punctuation">.</span>proxmox_vm_workers<span class="token punctuation">,</span>
    proxmox_vm_qemu<span class="token punctuation">.</span>proxmox_vm_master<span class="token punctuation">,</span>
    local_file<span class="token punctuation">.</span>k8s_file<span class="token punctuation">,</span>
    local_file<span class="token punctuation">.</span>var_file
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h1 id="ansible" style="position:relative;"><a href="#ansible" aria-label="ansible permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ansible</h1>
<p>Le cluster K3S est déployer via ansible. En voici l'arborescence :</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">ansible/
├── ansible.cfg
├── group_vars
│   └── all.yml
├── playbook.yml
└── roles
    ├── download
    │   └── tasks
    │       └── main.yml
    ├── k3s
    │   ├── master
    │   │   ├── tasks
    │   │   │   └── main.yml
    │   │   └── templates
    │   │       ├── k3s.service.j2
    │   │       └── k3s.service.j2.withoutterafic
    │   └── node
    │       ├── tasks
    │       │   └── main.yml
    │       └── templates
    │           └── k3s.service.j2
    ├── postconfig
    │   └── localhost
    │       └── tasks
    │           └── main.yml
    ├── prereq
    │   ├── defaults
    │   │   └── main.yml
    │   ├── tasks
    │   │   └── main.yml
    │   └── templates
    │       └── resolv.conf.j2
    ├── raspberrypi
    │   ├── handlers
    │   │   └── main.yml
    │   └── tasks
    │       ├── main.yml
    │       └── prereq
    │           ├── CentOS.yml
    │           ├── Raspbian.yml
    │           ├── Ubuntu.yml
    │           └── default.yml</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Voici les différents roles :</p>
<ul>
<li><code class="language-text">download</code> : Télécharge la release de k3s</li>
<li><code class="language-text">k3s</code> : La configuration de k3s pour le master et les nodes (rien de bien compliqué)</li>
<li><code class="language-text">postconfig</code> : On configure kubeconfig et installe helm en local sur le server/workstation exécutant le job ansible</li>
<li><code class="language-text">prereq</code> : On installe les prérequis K3S (netfilter, ip forwarding etc...)</li>
<li><code class="language-text">raspberrypi</code> : Un job spécifique si on est sous Raspberry PI</li>
</ul>
<p>A noter :</p>
<ul>
<li>Le fichier de group vars all.yml est généré via Terraform à partir de variables</li>
<li>Le fichier ansible.cfg peut être configurer à votre convenance</li>
</ul>
<h1 id="conclusion" style="position:relative;"><a href="#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h1>
<p>On a donc créé un cluster K3s de 0 sans aucune interaction directe ou manuelle avec Proxmox, pas mal non ? En plus de cela tous est dynamique et flexible, il suffit de changer les conf 😉</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 193px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f2380d33d87d2b65cfee893b785bb6fb/aadfe/final_promox.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 76.6839378238342%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACoUlEQVQoz3VSbW/SYBTlX/vBLDOa+MVopnExcXO6mC0z0w9uTgaMlwItdGPr6BsUWkpfaRkFWtpC357HwDajZp7c3NwPz7nn5pwnBSEo5XN7+1+GI+uihiEllKQolqTq2HmjcXVzY0EIAQDwIaQgBDTZrFaxMAgNSea4jqwomixriq5quuf5SzJ8GKnbrXPP/bD9nhqIcRyPhqY5MGVZNTRdVZSZN/+f+JIMIBzqyuPnj9bpLWmg41i1XCzn8shlvY6j6I3tQgiT1TMA4F1fDanbHQCAJI5iED10HbgrkNzP98qM4TGDZbXMOa0555xBig6lz0jVoXWXGXisOedGYXcc85OEs6KOFbMDjzF8xvBSha5d6Np5blqR5jvH2JOdTy/rZ3s5+sX20UGBePut9Oag8DlPvDvMvdrLbOxnt75XNg8LH0+biOilMNHBRAft2bg6/4G21jZf7/LnaNfOUxrSNk+JfvZaKbbMLNE7xjsZon9GKnlKzTTVWn+WCqIkiJJFGAMIBbFfubhoioIk6XX8QhB6bIenWrw2MHhJ43tik2I10+oI/dF4GoN7w5IkgRAKDLO+sfZ1VPAmHk2RmtTrdLsCL0hSnybJbrtNNK5kRTUNw7JGq6hW9iWrGMcTSxRFazR1bEfXNHu6xHg8jeMojpNFsHBdNwgCwxwGQQDh38pUo/F089mufGLIZgVBOIau4TiK4hTVLJUQrFJJn6Svr+kaWjOHJvwzZwih60zrl7gd+1EQ+r7vum4UJ0my/CBgGTIMwzAIgjAMF4vgX7I1HrE0y3cErIpmTo5+HqcZtoNWyhhSzJ4iVwTJUES5iOAYns7lfc/7TV5213PFntDmON+fz1zX833HtieTycQaO0sfHHs6dd2Z789t246i6BdNSiPdUxaiiwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="final promox"
        title="final promox"
        src="/static/f2380d33d87d2b65cfee893b785bb6fb/aadfe/final_promox.png"
        srcset="/static/f2380d33d87d2b65cfee893b785bb6fb/aadfe/final_promox.png 193w"
        sizes="(max-width: 193px) 100vw, 193px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Vous pouvez reprendre ce <a href="https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer">projet</a> (qui lui-même est forké). Par rapport à son utilisation tout est expliqué dans le <a href="https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer/blob/main/terraform/README.md">README</a>  et consiste principalement à changer des variables Terraform.</p>
<p>Malgré tous cela il y a pas mal d'axes d'améliorations et problèmes inhérents à la solution choisie :</p>
<ul>
<li>On pourrait mettre les variables sensibles dans Vault (Outil Hashicorp) et un git qui à chaque push redéploit une image packer.</li>
<li>Il faudrait aussi créer les utilisateurs adaptés (Terraform &#x26; Packer) avec les bons droits, voir ressource <a href="https://registry.terraform.io/providers/Telmate/proxmox/latest/docs">Terraform</a> par exemple.</li>
<li>Il faudrait que le job packer se termine au bon moment pour que le job Terraform ne se lance pas trop tôt (j'ai un sleep 30 pour l'instant)</li>
<li>Pas de provider packer natif donc on doit "tricher" pour supprimer le template</li>
<li>Terraform considère à un deuxième run que rien a changé et ne relance pas le job ansible (on peut tout de même le lancer à la main)</li>
</ul>
<p>Bref il y a plein d'autres moyens de faire et d'améliorer ce pipeline, les outils HashiCorp sont quand même super pour cela !</p>
<h1 id="sources" style="position:relative;"><a href="#sources" aria-label="sources permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sources</h1>
<p><a href="https://www.aerialls.eu/posts/ubuntu-server-2004-image-packer-subiquity-for-proxmox/">https://www.aerialls.eu/posts/ubuntu-server-2004-image-packer-subiquity-for-proxmox/</a><br>
<a href="https://tlhakhan.medium.com/ubuntu-server-20-04-autoinstall-2e5f772b655a">https://tlhakhan.medium.com/ubuntu-server-20-04-autoinstall-2e5f772b655a</a><br>
<a href="https://stackoverflow.com/questions/72567455/running-cloud-init-twice-via-packer-terraform-on-vmware-ubuntu-22-04-guest">https://stackoverflow.com/questions/72567455/running-cloud-init-twice-via-packer-terraform-on-vmware-ubuntu-22-04-guest</a><br>
<a href="https://salmonsec.com/blogs/home_lab_3#6-init-kubeadm-images-sh">https://salmonsec.com/blogs/home_lab_3#6-init-kubeadm-images-sh</a><br>
<a href="https://github.com/blz-ea/proxmox-packer">https://github.com/blz-ea/proxmox-packer</a><br>
<a href="https://medium.com/@ssnetanel/build-a-kubernetes-cluster-using-k3s-on-proxmox-via-ansible-and-terraform-c97c7974d4a5">https://medium.com/@ssnetanel/build-a-kubernetes-cluster-using-k3s-on-proxmox-via-ansible-and-terraform-c97c7974d4a5</a></p></div><div class="comment-box-wrapper container pt-7"><h1 class="mb-0">Comments</h1><hr class="my-0"/><div class="comment-box"></div></div></article></main><footer class="footer container"><div><a href="#">Back To Top</a></div><div><a href="/categories">Categories</a><a href="/tags">Tags</a><a href="https://github.com/ramuskay/blog-beerus" target="_blank" rel="noopener noreferrer">Source</a><a href="/rss.xml" target="_blank" rel="noopener noreferrer">RSS</a></div></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" defer="" src="https://u.calvin.me/script.js" data-website-id="90b1fd6b-e6ea-4725-848e-213b6cc123d2" data-auto-track="true" data-do-not-track="false"></script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/deploy-k3s-proxmox";window.___webpackCompilationHash="83f8760eefe07d8d0670";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-1f93a574953449163084.js"],"app":["/app-311f5bc98f50788f934e.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-a3eeeaf539efe992685c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-cba9fbe11e6caa2057f5.js"],"component---src-pages-categories-js":["/component---src-pages-categories-js-2bf9e29bc7f7dd9d2524.js"],"component---src-pages-index-js":["/component---src-pages-index-js-7244c3858ec4da3c3655.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-69d191532fe821988318.js"],"component---src-templates-category-js":["/component---src-templates-category-js-38e8087d83d028a0c6e9.js"],"component---src-templates-post-js":["/component---src-templates-post-js-0d74a984f046c51beb01.js"],"component---src-templates-tag-js":["/component---src-templates-tag-js-8c063f42fea386445bd9.js"]};/*]]>*/</script><script src="/polyfill-1f93a574953449163084.js" nomodule=""></script><script src="/app-311f5bc98f50788f934e.js" async=""></script><script src="/framework-0a721cd358c50da09b99.js" async=""></script><script src="/webpack-runtime-26faca4ef313ebafb109.js" async=""></script></body></html>