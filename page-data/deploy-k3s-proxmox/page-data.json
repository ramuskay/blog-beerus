{"componentChunkName":"component---src-templates-post-js","path":"/deploy-k3s-proxmox","result":{"data":{"markdownRemark":{"html":"<h1 id=\"architecture\" style=\"position:relative;\"><a href=\"#architecture\" aria-label=\"architecture permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture</h1>\n<p>Je suis en train de pr√©parer la Certified Kubernetes Administrator (CKA) et il me faudrait un lab pour m'exercer. J'ai pas mal fait de Kubernetes classique en lab via des formations Udemy et j'aimerai tester autre chose mais toujours sur une base K8S.\nJe me suis pench√© sur K3S de Rancher. Il dispose de plusieurs qualit√©s qui me semble int√©ressantes :</p>\n<ul>\n<li>Il est l√©ger et plus rapide que K8s</li>\n<li>Il peut s'ex√©cuter sur du plus petit mat√©riel (proc ARM par ex ü•∞). J'ai comme projet potentiel de faire un cluster de raspberry donc K3S est plus qu'indiqu√©.</li>\n<li>Il ne dispose pas de tous les connecteurs cloud mais vu que √ßa sera du \"on premise\" dans mon cas c'est parfait.</li>\n<li>Plein de petits avantages : + facile et rapide √† d√©ployer, moins de surface d'attaque, facile √† update etc...</li>\n</ul>\n<p>Par contre il ne fait pas tourner docker nativement mais containerd (bien que j'ai vu un projet passer s'appelant k3d qui int√®gre docker), √ßa sera l'occasion d'apprendre autre chose surtout que le CRI (Container Runtime Interface) en soi n'est pas le plus important.</p>\n<p>Une fois mon choix d'orchestrateur choisi je me suis dit que j'allais installer mon cluster K3s sur mon lab maison qui ex√©cute un Proxmox et tant qu'√† faire autant avoir un workflow de d√©ploiement un peu √©volu√© pour s'exercer.</p>\n<p>Parmi toutes les ressources que j'ai pu voir le workflow qui me semblait au d√©part le plus int√©ressant faisait les choses suivantes :</p>\n<ul>\n<li>R√©cup√©ration de l'ISO Ubuntu 20 sur Proxmox</li>\n<li>Cr√©ation du template Proxmox \"√† la main\" via des commandes qm (cli proxmox)</li>\n<li>Configuration de cloud init via l'onglet promox d√©di√©</li>\n<li>Cr√©ation des VM via Terraform</li>\n<li>Ansible pour d√©ployer K3s sur mes nouvelles VM</li>\n</ul>\n<p>Cela paraissait sympa sur le papier et puis √ßa permettait de mettre en application les quelques connaissances Terraform dont je disposais.\nMais √† bien r√©fl√©chir il y avait quand m√™me deux probl√®mes dans ce process :</p>\n<ul>\n<li>Une partie manuelle qui cassait un peu l'automatisation voulue. Si je pouvais automatiser cela je serais vraiment dans un cas d'IaC (<strong>Infra As Code</strong>)</li>\n<li>Pas tr√®s flexible car si je veux customiser mon template √ßa sera √† la main aussi ou √† la limite via script bash</li>\n</ul>\n<p>C'est l√† que je suis tomb√© sur un autre outil d'Hashicorp qui fait tout ce travail manuel pour moi et dispose de la flexibilit√© voulue : Packer !</p>\n<p></br>Voici les deux workflows qui sont ressortis au final :</p>\n<ul>\n<li>Cr√©ation du template --> Cloud init --> Terraform --> Ansible --> K3S</li>\n<li><strong>Packer (+Cloud init) --> Terraform --> Ansible --> K3S</strong></li>\n</ul>\n<p>J'ai donc choisi le deuxi√®me worflow<br>\nAvantages :</p>\n<ul>\n<li>Infra as code - Full automatis√©e</li>\n<li>Pas d'interaction directe avec Proxmox, seulement via son API</li>\n<li>Peut donc √™tre pilot√© depuis une machine tierce</li>\n</ul>\n<p>‚ö†Ô∏è Inconv√©nients :</p>\n<ul>\n<li>N√©cessite plus de d√©veloppement et de temps pour un r√©sultat √©quivalent dans mon cas (installation d'un potentiel DHCP, cr√©ation du fichier de conf packer etc...)</li>\n<li>Temps d'ex√©cution de cr√©ation du template plus long</li>\n</ul>\n<p>Retrouver l'ensemble du projet sur ce git : <a href=\"https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer\">https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer</a></p>\n<h1 id=\"packer\" style=\"position:relative;\"><a href=\"#packer\" aria-label=\"packer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Packer</h1>\n<p>Je vais donc utiliser packer pour packager mon image Ubuntu 20.04 avec quelques packages et confs additionnelles. Il suffit d'installer <a href=\"https://www.packer.io/downloads\">packer</a> puis nous verrons les fichiers de configuration.<br>\nD'ailleurs dans mon cas pas besoin de DHCP, celui de ma box avec ma VM template en mode bridge sera largement suffisant.<br>\nVoici mon arborescence packer pour la config :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">‚îú‚îÄ‚îÄ http\n‚îÇ   ‚îú‚îÄ‚îÄ meta-data\n‚îÇ   ‚îî‚îÄ‚îÄ user-data\n‚îú‚îÄ‚îÄ ubuntu20.pkr.hcl\n‚îî‚îÄ‚îÄ variables.pkr.hcl</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Les fichiers de conf peuvent √™tre en json ou HCL (format hashicorp), j'ai choisi HCL √† la place de JSON pour deux raisons :</p>\n<ul>\n<li>Langage commun avec tous les outils HashiCorp (vu qu'on va aussi utiliser Terraform √ßa a du sens)</li>\n<li>Plus \"fonctionnel\", on peut par exemple mettre des commentaires (dans JSON non √ßa fera toujours partie de la data)</li>\n</ul>\n<p>On a donc 2 fichiers hcl concernant :</p>\n<ul>\n<li><code class=\"language-text\">variables.pkr.hcl</code> : la d√©finition des variables par d√©faut</li>\n<li><code class=\"language-text\">ubuntu20.pkr.hcl</code> : la d√©finition du job packer</li>\n</ul>\n<p>Regardons plus en d√©tail <code class=\"language-text\">ubuntu20.pkr.hcl</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">source <span class=\"token string-literal\"><span class=\"token string\">\"proxmox\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"template\"</span></span> <span class=\"token punctuation\">{</span>\n  proxmox_url <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${var.proxmox_hostname}/api2/json\"</span></span>\n  username <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>proxmox_username\n  password <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>proxmox_password\n  node <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>proxmox_node_name\n  insecure_skip_tls_verify <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>proxmox_insecure_skip_tls_verify\n  network_adapters <span class=\"token punctuation\">{</span>\n    bridge <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"vmbr0\"</span></span>\n  <span class=\"token punctuation\">}</span>\n  disks <span class=\"token punctuation\">{</span>\n    type <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"scsi\"</span></span>\n    disk_size <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"20G\"</span></span>\n    storage_pool <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_storage_pool\n    storage_pool_type <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"lvm\"</span></span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">#iso_file = \"local:iso/ubuntu-20.04.4-live-server-amd64.iso\"</span>\n  iso_url               <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>iso_url\n  iso_storage_pool      <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>iso_storage_pool\n  iso_checksum          <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>iso_checksum\n  unmount_iso <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  boot_wait <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"5s\"</span></span>\n  memory <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_memory\n  sockets   <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_sockets\n  cores     <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_cores\n  template_name <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_name\n  vm_id     <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_id\n  http_directory <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>http_directory\n  cloud_init <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  cloud_init_storage_pool <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>iso_storage_pool\n  boot_command <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"&lt;esc>&lt;wait>&lt;esc>&lt;wait>&lt;f6>&lt;wait>&lt;esc>&lt;wait>\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"&lt;bs>&lt;bs>&lt;bs>&lt;bs>&lt;bs>\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"autoinstall ds=nocloud-net;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ \"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"--- &lt;enter>\"</span></span>\n  <span class=\"token punctuation\">]</span>\n  ssh_username <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>username\n  ssh_password <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>user_password\n  ssh_timeout <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"20m\"</span></span>\n<span class=\"token punctuation\">}</span>\n\nbuild <span class=\"token punctuation\">{</span>\n  sources <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string-literal\"><span class=\"token string\">\"source.proxmox.template\"</span></span>\n  <span class=\"token punctuation\">]</span>\n  provisioner <span class=\"token string-literal\"><span class=\"token string\">\"shell\"</span></span> <span class=\"token punctuation\">{</span>\n    inline <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"sudo rm -f /etc/cloud/cloud.cfg.d/99-installer.cfg\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"sudo rm -f /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"sudo cloud-init clean\"</span></span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Rien de bien compliqu√© l√†-dedans c'est aussi l'avantage en g√©n√©ral des outils Hashicorp la configuration est tr√®s descriptive et donc compr√©hensible rapidement.\nOn va renseigner les informations suivantes :</p>\n<ul>\n<li>Des credentials pour le proxmox</li>\n<li>Un peu de hardware pour le template (RAM, CPU, Disk etc...)</li>\n<li>Une config pour le template (ID, nom, boot command , ssh cred etc...)</li>\n<li>Un dossier pour la conf subiquity</li>\n<li><strong>On active cloud-init car sinon on ne peut pas set les IP via Terraform</strong></li>\n<li>On tweak un peu l'image car on veut qu'elle soit cloud-init ready</li>\n</ul>\n<p>Justement concernant autoinstall depuis la version 20.04 preseed a √©t√© d√©laiss√© au profit de subiquity qui est (de mon point de vue) bien plus facile √† utiliser car format yaml et s'int√®gre tr√®s bien avec Packer. Ce qui donne deux fichiers :</p>\n<ul>\n<li><code class=\"language-text\">meta-data</code> : requis. Utilis√© par le cloud vu qu'on d√©ploit en local on le laisse vide</li>\n<li><code class=\"language-text\">user-data</code> : l'√©quivalent du preseed, utilise autoinstall</li>\n</ul>\n<p>Le fichier <code class=\"language-text\">user-data</code> en d√©tail :</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\"><span class=\"token comment\">#cloud-config</span>\n<span class=\"token key atrule\">autoinstall</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">locale</span><span class=\"token punctuation\">:</span> en_US\n  <span class=\"token key atrule\">keyboard</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">layout</span><span class=\"token punctuation\">:</span> fr\n  <span class=\"token key atrule\">ssh</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">install-server</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">allow-pw</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">packages</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> qemu<span class=\"token punctuation\">-</span>guest<span class=\"token punctuation\">-</span>agent\n  <span class=\"token key atrule\">user-data</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">users</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> canadium\n          <span class=\"token key atrule\">passwd</span><span class=\"token punctuation\">:</span> $6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0\n          <span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>adm<span class=\"token punctuation\">,</span> cdrom<span class=\"token punctuation\">,</span> dip<span class=\"token punctuation\">,</span> plugdev<span class=\"token punctuation\">,</span> sudo<span class=\"token punctuation\">]</span>\n          <span class=\"token key atrule\">lock-passwd</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n          <span class=\"token key atrule\">sudo</span><span class=\"token punctuation\">:</span> ALL=(ALL) NOPASSWD<span class=\"token punctuation\">:</span>ALL\n          <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> /bin/bash\n          <span class=\"token key atrule\">ssh_authorized_keys</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ssh<span class=\"token punctuation\">-</span>ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJEXrwiuUOCpWPvwOsGuF4K+aq1ufToGMi4ra/1omOZb</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Fichier de configuration ultra basique, on d√©finit un seul user et deux confs pour le syst√®me. Les autres options peuvent √™tre trouv√©es dans la <a href=\"https://ubuntu.com/server/docs/install/autoinstall-reference\">doc</a><br>\n‚ö†Ô∏è Ce fichier est \"templatiser\" et red√©fini via Terraform voir plus bas</p>\n<p>On peut ensuite ex√©cuter packer via Terraform pour avoir une seule et m√™me ex√©cution<br>\nCe qui nous donne un template de qualit√© !\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 850px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cc6a97ebfa97429c534052f94c048994/d8a90/template-proxmox.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.131455399061025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA20lEQVQoz5WQy26DMBRE/f+/1nV3lNC4bkgwL2NjHoapxhKIRdSEkUawuPd45oqLzJGpB+73AnVZoqkbFEUB33tQ67qesvj4/EJyq9FPAXNYopdlQQgB0zRhnueX3ua4I26/Cs4adK7HjzbQTYfBe/gTHoZh/4o0TaHLEuM4Ql6/Ybtur/qumIxnYlKhlELbtpF+yTIYY3bYOzejeCLus7ZIkgRa60jnv5QyvngGyLoMxpYiz3NUVRXp22vHhP/pOMc9WpDunIsJnw2/0nEuAq21oDfgscqZhBvwD9YwwWrhe2wrAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"template proxmox\"\n        title=\"template proxmox\"\n        src=\"/static/cc6a97ebfa97429c534052f94c048994/d6170/template-proxmox.png\"\n        srcset=\"/static/cc6a97ebfa97429c534052f94c048994/53f68/template-proxmox.png 213w,\n/static/cc6a97ebfa97429c534052f94c048994/df70d/template-proxmox.png 425w,\n/static/cc6a97ebfa97429c534052f94c048994/d6170/template-proxmox.png 850w,\n/static/cc6a97ebfa97429c534052f94c048994/d8a90/template-proxmox.png 920w\"\n        sizes=\"(max-width: 850px) 100vw, 850px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"terraform\" style=\"position:relative;\"><a href=\"#terraform\" aria-label=\"terraform permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Terraform</h1>\n<p>Il faut maintenant d√©ployer notre template sous forme de VM, on va utiliser Terraform pour qui sera notre outil principal. <strong>Tout</strong> passera par Terraform :</p>\n<ul>\n<li>La cr√©ation de fichier de conf pour Packer, Ansible et Terraform</li>\n<li>L'ex√©cution de Packer</li>\n<li>L'ex√©cution de Terraform bien s√ªr</li>\n<li>L'ex√©cution d'Ansible</li>\n</ul>\n<p>On installe <a href=\"https://learn.hashicorp.com/tutorials/terraform/install-cli?in=terraform/aws-get-started\">Terraform</a> puis on s'attaque aux fichiers de configuration :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">‚îú‚îÄ‚îÄ main.tf\n‚îú‚îÄ‚îÄ output.tf\n‚îú‚îÄ‚îÄ provider.tf\n‚îú‚îÄ‚îÄ terraform.tfvars\n‚îî‚îÄ‚îÄ variables.tf</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Listons les fichiers Terraform :</p>\n<ul>\n<li><code class=\"language-text\">main.tf</code> : On d√©crit notre d√©ploiement, le fichier de job.</li>\n<li><code class=\"language-text\">output.tf</code> : La sortie voulue lors de l'ex√©cution de Terraform apply (on va print les IP ici)</li>\n<li><code class=\"language-text\">provider.tf</code> : On pr√©cise quel provider on utilise, ici proxmox. (voir <a href=\"https://registry.terraform.io/providers/Telmate/proxmox/latest/docs\">doc</a>)</li>\n<li><code class=\"language-text\">terraform.tfvars</code> : la d√©finition des variables pour le main.tf (m√™me principe que Packer)</li>\n<li><code class=\"language-text\">variables.tf</code> : la d√©finition des variables par d√©faut (m√™me principe que Packer)</li>\n</ul>\n<p>Et on a des fichiers de template qui vont nous permettre de d√©finir notre inventory ansible, groups_vars ansible, user-data de autoinstall etc...</p>\n<p>Je vais juste d√©crire le fichier main.tf car les autres sont plut√¥t √©vident.\nOn d√©finit les variables pour l'ex√©cution future de packer :</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">locals <span class=\"token punctuation\">{</span>\n  template_folder <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${path.module}/${var.folder_packer}/${var.distrib_folder}\"</span></span>\n  packer_cfg <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    PKR_VAR_proxmox_hostname  <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>pm_host\n    PKR_VAR_proxmox_username  <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>pm_user\n    PKR_VAR_proxmox_password  <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>pm_password\n    PKR_VAR_proxmox_node_name <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>pm_node_name\n    PKR_VAR_proxmox_insecure_skip_tls_verify <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>pm_tls_insecure\n\n    PKR_VAR_vm_id                 <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_id\n    PKR_VAR_vm_name               <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_name\n    PKR_VAR_vm_storage_pool       <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_storage_pool\n    PKR_VAR_vm_cores              <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_cores\n    PKR_VAR_vm_memory             <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_memory\n    PKR_VAR_vm_sockets            <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>vm_sockets\n\n    PKR_VAR_iso_url             <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>iso_url\n    PKR_VAR_iso_storage_pool    <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>iso_storage_pool\n    PKR_VAR_iso_checksum        <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>iso_checksum\n\n    PKR_VAR_http_directory      <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>http_directory\n\n    PKR_VAR_username              <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>username\n    PKR_VAR_user_password         <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>user_password\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Ici justement on d√©finit le job packer avec l'ensemble des param√®tres souhait√©s (au final c'est une ex√©cution shell classique).<br>\nJ'ai ajout√© un petit sleep car parfois le template n'√©tait pas pr√™t pour l'ex√©cution Terraform. √âgalement un script python pour supprimer le template cr√©√© par Packer (pas de ressource native donc oblig√© de \"hack\") :</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">resource <span class=\"token string-literal\"><span class=\"token string\">\"null_resource\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"packer_build\"</span></span> <span class=\"token punctuation\">{</span>\n    provisioner <span class=\"token string-literal\"><span class=\"token string\">\"local-exec\"</span></span> <span class=\"token punctuation\">{</span>\n    working_dir <span class=\"token operator\">=</span> local<span class=\"token punctuation\">.</span>template_folder\n    command     <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"packer build . &amp;&amp; sleep 30\"</span></span>\n    environment <span class=\"token operator\">=</span> local<span class=\"token punctuation\">.</span>packer_cfg\n  <span class=\"token punctuation\">}</span>\n  provisioner <span class=\"token string-literal\"><span class=\"token string\">\"local-exec\"</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">when</span>  <span class=\"token operator\">=</span> destroy\n    command <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${path.module}/scripts/delete_template.py\"</span></span>\n    interpreter <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"python\"</span></span><span class=\"token punctuation\">]</span>\n    working_dir <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token keyword\">module</span>\n    <span class=\"token class-name\">environment</span> <span class=\"token operator\">=</span> merge<span class=\"token punctuation\">(</span>yamldecode<span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>triggers<span class=\"token punctuation\">.</span>packer_cfg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n    triggers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    packer_cfg <span class=\"token operator\">=</span> yamlencode<span class=\"token punctuation\">(</span>local<span class=\"token punctuation\">.</span>packer_cfg<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  depends_on <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    local_file<span class=\"token punctuation\">.</span>user<span class=\"token operator\">-</span>data\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On red√©finit un master K3S par-dessus notre template (var.tamplate_vm_name), on remarque qu'on doit pr√©ciser une d√©pendance pour que les t√¢ches s'ex√©cutent dans le bon ordre. A noter aussi un script sh qui v√©rifiera que le d√©ploiement cloud-init est bien fini sur le serveur :</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">resource <span class=\"token string-literal\"><span class=\"token string\">\"proxmox_vm_qemu\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"proxmox_vm_master\"</span></span> <span class=\"token punctuation\">{</span>\n  count       <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>num_k3s_masters\n  name        <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"k3s-master-${count.index}\"</span></span>\n  target_node <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>pm_node_name\n  clone       <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>template_vm_name\n  os_type     <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"cloud-init\"</span></span>\n  agent       <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n  memory      <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>num_k3s_masters_mem\n  cores       <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>num_k3s_masters_cpu\n\n  ipconfig0 <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"ip=${var.master_ips[count.index]}/${var.networkrange},gw=${var.gateway}\"</span></span>\n\n  lifecycle <span class=\"token punctuation\">{</span>\n    ignore_changes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n      ciuser<span class=\"token punctuation\">,</span>\n      sshkeys<span class=\"token punctuation\">,</span>\n      disk<span class=\"token punctuation\">,</span>\n      desc<span class=\"token punctuation\">,</span>\n      network\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  connection <span class=\"token punctuation\">{</span>\n    type <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"ssh\"</span></span>\n    user <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>username\n    password <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>user_password\n    host <span class=\"token operator\">=</span> var<span class=\"token punctuation\">.</span>worker_ips<span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">.</span>index<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  provisioner <span class=\"token string-literal\"><span class=\"token string\">\"file\"</span></span> <span class=\"token punctuation\">{</span>\n    source      <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${path.module}/scripts/wait-cloud-init.sh\"</span></span>\n    destination <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"/tmp/wait-cloud-init.sh\"</span></span>\n  <span class=\"token punctuation\">}</span>\n\n  provisioner <span class=\"token string-literal\"><span class=\"token string\">\"remote-exec\"</span></span> <span class=\"token punctuation\">{</span>\n    inline <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"chmod +x /tmp/wait-cloud-init.sh\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"/tmp/wait-cloud-init.sh\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n  depends_on <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    null_resource<span class=\"token punctuation\">.</span>packer_build\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On fera la m√™me t√¢che pour les workers</p>\n<p>Et ici on d√©finit nos t√¢ches de customisation de conf, c'est √† dire :</p>\n<ul>\n<li>G√©n√©rer des fichiers de configuration pour la future ex√©cution d'ansible</li>\n<li>G√©n√©rer le user-data n√©cessaire √† l'autoinstall de packer (on modifie essentiellement le user/password)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">data <span class=\"token string-literal\"><span class=\"token string\">\"template_file\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"cloud-init-user-data\"</span></span> <span class=\"token punctuation\">{</span>\n    template <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${file(\"</span></span>$<span class=\"token punctuation\">{</span>path<span class=\"token punctuation\">.</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">}</span><span class=\"token operator\">/</span>templates<span class=\"token operator\">/</span>user<span class=\"token operator\">-</span>data<span class=\"token punctuation\">.</span>tpl<span class=\"token string-literal\"><span class=\"token string\">\")}\"</span></span>\n    vars <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token constant\">SUDO_PASSWORD_HASH</span> <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${var.user_password_hash}\"</span></span>\n        <span class=\"token constant\">SUDO_USERNAME</span> <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${var.username}\"</span></span>\n        <span class=\"token constant\">SSH_PUBLIC_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${var.ssh_pub_key}\"</span></span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\nresource <span class=\"token string-literal\"><span class=\"token string\">\"local_file\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"user-data\"</span></span> <span class=\"token punctuation\">{</span>\n    content     <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${data.template_file.cloud-init-user-data.rendered}\"</span></span>\n    filename <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${local.template_folder}/http/user-data\"</span></span>\n<span class=\"token punctuation\">}</span>\n\ndata <span class=\"token string-literal\"><span class=\"token string\">\"template_file\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"k8s\"</span></span> <span class=\"token punctuation\">{</span>\n  template <span class=\"token operator\">=</span> file<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"./templates/k8s.tpl\"</span></span><span class=\"token punctuation\">)</span>\n  vars <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    k3s_master_ip <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${join(\"</span></span>\\n<span class=\"token string-literal\"><span class=\"token string\">\", [for instance in proxmox_vm_qemu.proxmox_vm_master : join(\"</span></span><span class=\"token string-literal\"><span class=\"token string\">\", [instance.default_ipv4_address, \"</span></span> ansible_ssh_private_key_file<span class=\"token operator\">=</span><span class=\"token string-literal\"><span class=\"token string\">\", var.pvt_key])])}\"</span></span>\n    k3s_node_ip   <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${join(\"</span></span>\\n<span class=\"token string-literal\"><span class=\"token string\">\", [for instance in proxmox_vm_qemu.proxmox_vm_workers : join(\"</span></span><span class=\"token string-literal\"><span class=\"token string\">\", [instance.default_ipv4_address, \"</span></span> ansible_ssh_private_key_file<span class=\"token operator\">=</span><span class=\"token string-literal\"><span class=\"token string\">\", var.pvt_key])])}\"</span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nresource <span class=\"token string-literal\"><span class=\"token string\">\"local_file\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"k8s_file\"</span></span> <span class=\"token punctuation\">{</span>\n  content  <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>template_file<span class=\"token punctuation\">.</span>k8s<span class=\"token punctuation\">.</span>rendered\n  filename <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${path.module}/ansible/hosts\"</span></span>\n<span class=\"token punctuation\">}</span>\n\ndata <span class=\"token string-literal\"><span class=\"token string\">\"template_file\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"groups_vars_ansible\"</span></span> <span class=\"token punctuation\">{</span>\n    template <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${file(\"</span></span>$<span class=\"token punctuation\">{</span>path<span class=\"token punctuation\">.</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">}</span><span class=\"token operator\">/</span>templates<span class=\"token operator\">/</span>all<span class=\"token punctuation\">.</span>tpl<span class=\"token string-literal\"><span class=\"token string\">\")}\"</span></span>\n    vars <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token constant\">ANSIBLE_USER</span> <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${var.username}\"</span></span>\n        <span class=\"token constant\">K3S_VERSION</span> <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${var.k3s_version}\"</span></span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nresource <span class=\"token string-literal\"><span class=\"token string\">\"local_file\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"groups_vars_ansible\"</span></span> <span class=\"token punctuation\">{</span>\n    content     <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${data.template_file.groups_vars_ansible.rendered}\"</span></span>\n    filename <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"${path.module}/ansible/group_vars/all.yml\"</span></span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Et enfin le job ansible :</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">resource <span class=\"token string-literal\"><span class=\"token string\">\"null_resource\"</span></span> <span class=\"token string-literal\"><span class=\"token string\">\"ansible-playbook\"</span></span> <span class=\"token punctuation\">{</span>\n  provisioner <span class=\"token string-literal\"><span class=\"token string\">\"local-exec\"</span></span> <span class=\"token punctuation\">{</span>\n    command <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"ansible-playbook -i ${var.inventory_file}  --private-key ${var.ssh_key_file} site.yml\"</span></span>\n    working_dir <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"..\"</span></span>\n  <span class=\"token punctuation\">}</span>\n  depends_on <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    proxmox_vm_qemu<span class=\"token punctuation\">.</span>proxmox_vm_workers<span class=\"token punctuation\">,</span>\n    proxmox_vm_qemu<span class=\"token punctuation\">.</span>proxmox_vm_master<span class=\"token punctuation\">,</span>\n    local_file<span class=\"token punctuation\">.</span>k8s_file<span class=\"token punctuation\">,</span>\n    local_file<span class=\"token punctuation\">.</span>var_file\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id=\"ansible\" style=\"position:relative;\"><a href=\"#ansible\" aria-label=\"ansible permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ansible</h1>\n<p>Le cluster K3S est d√©ployer via ansible. En voici l'arborescence :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">ansible/\n‚îú‚îÄ‚îÄ ansible.cfg\n‚îú‚îÄ‚îÄ group_vars\n‚îÇ   ‚îî‚îÄ‚îÄ all.yml\n‚îú‚îÄ‚îÄ playbook.yml\n‚îî‚îÄ‚îÄ roles\n    ‚îú‚îÄ‚îÄ download\n    ‚îÇ   ‚îî‚îÄ‚îÄ tasks\n    ‚îÇ       ‚îî‚îÄ‚îÄ main.yml\n    ‚îú‚îÄ‚îÄ k3s\n    ‚îÇ   ‚îú‚îÄ‚îÄ master\n    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates\n    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ k3s.service.j2\n    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ k3s.service.j2.withoutterafic\n    ‚îÇ   ‚îî‚îÄ‚îÄ node\n    ‚îÇ       ‚îú‚îÄ‚îÄ tasks\n    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n    ‚îÇ       ‚îî‚îÄ‚îÄ templates\n    ‚îÇ           ‚îî‚îÄ‚îÄ k3s.service.j2\n    ‚îú‚îÄ‚îÄ postconfig\n    ‚îÇ   ‚îî‚îÄ‚îÄ localhost\n    ‚îÇ       ‚îî‚îÄ‚îÄ tasks\n    ‚îÇ           ‚îî‚îÄ‚îÄ main.yml\n    ‚îú‚îÄ‚îÄ prereq\n    ‚îÇ   ‚îú‚îÄ‚îÄ defaults\n    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n    ‚îÇ   ‚îú‚îÄ‚îÄ tasks\n    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n    ‚îÇ   ‚îî‚îÄ‚îÄ templates\n    ‚îÇ       ‚îî‚îÄ‚îÄ resolv.conf.j2\n    ‚îú‚îÄ‚îÄ raspberrypi\n    ‚îÇ   ‚îú‚îÄ‚îÄ handlers\n    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n    ‚îÇ   ‚îî‚îÄ‚îÄ tasks\n    ‚îÇ       ‚îú‚îÄ‚îÄ main.yml\n    ‚îÇ       ‚îî‚îÄ‚îÄ prereq\n    ‚îÇ           ‚îú‚îÄ‚îÄ CentOS.yml\n    ‚îÇ           ‚îú‚îÄ‚îÄ Raspbian.yml\n    ‚îÇ           ‚îú‚îÄ‚îÄ Ubuntu.yml\n    ‚îÇ           ‚îî‚îÄ‚îÄ default.yml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Voici les diff√©rents roles :</p>\n<ul>\n<li><code class=\"language-text\">download</code> : T√©l√©charge la release de k3s</li>\n<li><code class=\"language-text\">k3s</code> : La configuration de k3s pour le master et les nodes (rien de bien compliqu√©)</li>\n<li><code class=\"language-text\">postconfig</code> : On configure kubeconfig et installe helm en local sur le server/workstation ex√©cutant le job ansible</li>\n<li><code class=\"language-text\">prereq</code> : On installe les pr√©requis K3S (netfilter, ip forwarding etc...)</li>\n<li><code class=\"language-text\">raspberrypi</code> : Un job sp√©cifique si on est sous Raspberry PI</li>\n</ul>\n<p>A noter :</p>\n<ul>\n<li>Le fichier de group vars all.yml est g√©n√©r√© via Terraform √† partir de variables</li>\n<li>Le fichier ansible.cfg peut √™tre configurer √† votre convenance</li>\n</ul>\n<h1 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h1>\n<p>On a donc cr√©√© un cluster K3s de 0 sans aucune interaction directe ou manuelle avec Proxmox, pas mal non ? En plus de cela tous est dynamique et flexible, il suffit de changer les conf üòâ</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 193px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f2380d33d87d2b65cfee893b785bb6fb/aadfe/final_promox.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.6839378238342%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACoUlEQVQoz3VSbW/SYBTlX/vBLDOa+MVopnExcXO6mC0z0w9uTgaMlwItdGPr6BsUWkpfaRkFWtpC357HwDajZp7c3NwPz7nn5pwnBSEo5XN7+1+GI+uihiEllKQolqTq2HmjcXVzY0EIAQDwIaQgBDTZrFaxMAgNSea4jqwomixriq5quuf5SzJ8GKnbrXPP/bD9nhqIcRyPhqY5MGVZNTRdVZSZN/+f+JIMIBzqyuPnj9bpLWmg41i1XCzn8shlvY6j6I3tQgiT1TMA4F1fDanbHQCAJI5iED10HbgrkNzP98qM4TGDZbXMOa0555xBig6lz0jVoXWXGXisOedGYXcc85OEs6KOFbMDjzF8xvBSha5d6Np5blqR5jvH2JOdTy/rZ3s5+sX20UGBePut9Oag8DlPvDvMvdrLbOxnt75XNg8LH0+biOilMNHBRAft2bg6/4G21jZf7/LnaNfOUxrSNk+JfvZaKbbMLNE7xjsZon9GKnlKzTTVWn+WCqIkiJJFGAMIBbFfubhoioIk6XX8QhB6bIenWrw2MHhJ43tik2I10+oI/dF4GoN7w5IkgRAKDLO+sfZ1VPAmHk2RmtTrdLsCL0hSnybJbrtNNK5kRTUNw7JGq6hW9iWrGMcTSxRFazR1bEfXNHu6xHg8jeMojpNFsHBdNwgCwxwGQQDh38pUo/F089mufGLIZgVBOIau4TiK4hTVLJUQrFJJn6Svr+kaWjOHJvwzZwih60zrl7gd+1EQ+r7vum4UJ0my/CBgGTIMwzAIgjAMF4vgX7I1HrE0y3cErIpmTo5+HqcZtoNWyhhSzJ4iVwTJUES5iOAYns7lfc/7TV5213PFntDmON+fz1zX833HtieTycQaO0sfHHs6dd2Z789t246i6BdNSiPdUxaiiwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"final promox\"\n        title=\"final promox\"\n        src=\"/static/f2380d33d87d2b65cfee893b785bb6fb/aadfe/final_promox.png\"\n        srcset=\"/static/f2380d33d87d2b65cfee893b785bb6fb/aadfe/final_promox.png 193w\"\n        sizes=\"(max-width: 193px) 100vw, 193px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Vous pouvez reprendre ce <a href=\"https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer\">projet</a> (qui lui-m√™me est fork√©). Par rapport √† son utilisation tout est expliqu√© dans le <a href=\"https://github.com/ramuskay/k3s-proxmox-terraform-ansible-packer/blob/main/terraform/README.md\">README</a>  et consiste principalement √† changer des variables Terraform.</p>\n<p>Malgr√© tous cela il y a pas mal d'axes d'am√©liorations et probl√®mes inh√©rents √† la solution choisie :</p>\n<ul>\n<li>On pourrait mettre les variables sensibles dans Vault (Outil Hashicorp) et un git qui √† chaque push red√©ploit une image packer.</li>\n<li>Il faudrait aussi cr√©er les utilisateurs adapt√©s (Terraform &#x26; Packer) avec les bons droits, voir ressource <a href=\"https://registry.terraform.io/providers/Telmate/proxmox/latest/docs\">Terraform</a> par exemple.</li>\n<li>Il faudrait que le job packer se termine au bon moment pour que le job Terraform ne se lance pas trop t√¥t (j'ai un sleep 30 pour l'instant)</li>\n<li>Pas de provider packer natif donc on doit \"tricher\" pour supprimer le template</li>\n<li>Terraform consid√®re √† un deuxi√®me run que rien a chang√© et ne relance pas le job ansible (on peut tout de m√™me le lancer √† la main)</li>\n</ul>\n<p>Bref il y a plein d'autres moyens de faire et d'am√©liorer ce pipeline, les outils HashiCorp sont quand m√™me super pour cela !</p>\n<h1 id=\"sources\" style=\"position:relative;\"><a href=\"#sources\" aria-label=\"sources permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sources</h1>\n<p><a href=\"https://www.aerialls.eu/posts/ubuntu-server-2004-image-packer-subiquity-for-proxmox/\">https://www.aerialls.eu/posts/ubuntu-server-2004-image-packer-subiquity-for-proxmox/</a><br>\n<a href=\"https://tlhakhan.medium.com/ubuntu-server-20-04-autoinstall-2e5f772b655a\">https://tlhakhan.medium.com/ubuntu-server-20-04-autoinstall-2e5f772b655a</a><br>\n<a href=\"https://stackoverflow.com/questions/72567455/running-cloud-init-twice-via-packer-terraform-on-vmware-ubuntu-22-04-guest\">https://stackoverflow.com/questions/72567455/running-cloud-init-twice-via-packer-terraform-on-vmware-ubuntu-22-04-guest</a><br>\n<a href=\"https://salmonsec.com/blogs/home_lab_3#6-init-kubeadm-images-sh\">https://salmonsec.com/blogs/home_lab_3#6-init-kubeadm-images-sh</a><br>\n<a href=\"https://github.com/blz-ea/proxmox-packer\">https://github.com/blz-ea/proxmox-packer</a><br>\n<a href=\"https://medium.com/@ssnetanel/build-a-kubernetes-cluster-using-k3s-on-proxmox-via-ansible-and-terraform-c97c7974d4a5\">https://medium.com/@ssnetanel/build-a-kubernetes-cluster-using-k3s-on-proxmox-via-ansible-and-terraform-c97c7974d4a5</a></p>","timeToRead":13,"excerpt":"Architecture Je suis en train de pr√©parer la Certified Kubernetes Administrator (CKA) et il me faudrait un lab pour m'exercer. J'ai pas mal‚Ä¶","fileAbsolutePath":"/home/runner/work/blog-beerus/blog-beerus/master/posts/2022/2022-07-19-deploy-k3s-proxmox/index.md","frontmatter":{"title":"D√©ployer son infra K3S sur Proxmox en mode IaC","categories":["Infra"],"tags":["k3s","hashicorp","packer","terraform","proxmox"],"thumbnail":{"childImageSharp":null,"extension":"svg","publicURL":"/static/64b41253bfd937c25ba662b031195cdc/thumbnail.svg"}}}},"pageContext":{"filter":"/^.*\\/\\d{4}-\\d{2}-\\d{2}-deploy-k3s-proxmox\\/.*$/"}},"staticQueryHashes":[]}