{"componentChunkName":"component---src-templates-post-js","path":"/redondance-sites","result":{"data":{"markdownRemark":{"html":"<h1 id=\"contexte\" style=\"position:relative;\"><a href=\"#contexte\" aria-label=\"contexte permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Contexte</h1>\n<p>Mon serveur hébergé a des petits soucis en ce moment, il a tendance à planter régulièrement malgré le fait que je le supervise activement.<br>\nJ'ai très longtemps pensé que c'était l'un de mes containers docker qui s'emballait (malgré le fait qu'il y ait des options de runtime de paramétrées) mais il s'avère que c'est le metrics scraper d'OVH installé qui posait problème !<br>\nBref avant de résoudre le problème, mes services hébergés ne répondaient plus de temps en temps et cela reste tout de même très embêtant. Il a donc fallu que je pense à une potentielle redondance !</p>\n<h1 id=\"etude-des-solutions\" style=\"position:relative;\"><a href=\"#etude-des-solutions\" aria-label=\"etude des solutions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Etude des solutions</h1>\n<p>Il fallait donc que je trouve une solution pour avoir les sites les plus importants toujours en fonction en cas de défaillance majeure de mon serveur dédié le temps que je trouve une solution à long terme. Pour simplifier la problématique je ne souhaite basculer qu'un seul site pour le moment car il est consulté fréquemment pour des raisons professionnelles, les autres n'ont pas d'importance cruciale.</p>\n<p>J'ai les équipements suivants avec moi :</p>\n<ul>\n<li>Une IP publique dédiée d'OVH</li>\n<li>Un serveur hébergé chez OVH</li>\n<li>Un micro serveur avec des ressources équivalentes de celle d'OVH chez moi</li>\n<li>La fibre et une IP publique dynamique (celle de ma box)</li>\n</ul>\n<p>Voici les quelques techniques auxquelles j'ai pensé en premier lieu :</p>\n<ul>\n<li>Backup, Replica</li>\n<li>Cluster</li>\n<li>Solution de fail over</li>\n</ul>\n<p>La solution <strong>backup/réplica</strong> a tout de suite été écartée du fait qu'elle ne soit pas du tout flexible. Je fais déjà du backup de mon serveur vers chez moi mais c'est cela concerne plus la conf de mon dockerfile et les datas de certains containers mais rien qui ne me permet de remonter une infra en 10min automatiquement (surtout pour une solution censée rester temporaire).<br>\nPour le <strong>cluster</strong> ça serait la solution idéale, dans mon cas passer sous Docker Swarm ou encore mieux tout migrer sous K8s/K3s. Le problème est que je veux une solution rapide à mettre en place ne necessitant pas une refonte complète de mon infra. D'autant plus que je n'ai pas du tout réfléchi à la conception de ma future infra et comment cela est géré avec une IP publique dynamique.<br>\nLa dernière proposition est surement la plus adaptée pour moi, trouver une <strong>solution de failover</strong> simple et efficace avec le moins d'intervention humaine sans toucher à la configuration déjà en place.</p>\n<p>Une fois choisie il a fallu que je compare les solutions avec les contraintes suivantes :</p>\n<ul>\n<li>Une bascule faite en 5 minutes max en cas de problème.</li>\n<li>L'ensemble des données doivent être identique et synchronisé (si modification d'un fichier html réplication immédiate sur le backup).</li>\n<li>Rapide et simple à mettre en place, pas de service payant etc...</li>\n</ul>\n<p>Après un moment de réflexion voici le workflow imaginé :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 799px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b40409ff0374b8d105c68dfa76bfa3f/dd6e8/schema_failover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.69014084507043%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACdElEQVQ4y21Ua5OiQAzk//+w+3BVt+4pyCpvmAEGUN4goPZVsovluUtVagaS6XQ6E7TLNOPZxsuEeVlQtz38SCFWJTyRIy1q+DJHFOfIzzWm+TOWbD1Hpr2CUWBDYELxNyklHNdlEzLGNC8I4wLzcn2APZu2IpMN44UPnKsWvsjQdANknCASAkIIpCpj/8EJeb9cb2i7ns/S2vUDNAogx2qUhVl2A5wg5VLjrELbT0jzGoHMEac5LNuBHwQIghDmxxFHy0IkJLSm7RAnKZJU8doPI5dD4HXTIFUKoYhxtH2EkWQW5L/e7ggjAV03OIbOs4ZBGPFLXTcQQmK73XEglWqaH3jbvGOnG9jqOu8d12MtbceFsTc5tqobZkyrRjSJJTE6nUumTSzoG7EdxwuGfsDYD5i+GrdqTRURCD20L6saGmUj+zhaXJKUMQMRKFk7jOhtD8POREvvXY+27Rg4TRU2m3e4js9siYQWyhidynE3LZzLCtudDpXlUCrjTqZ5gTwUOB1s3qssY39xOsH1fGZ26mv4YYi6bqGFQiJ0XOReAN/zWaumaXG749H56cvmeeFSyUfaGYaJQEYQVcracslU3qmsUFQ1a0jvlJUSOZ4HahppR7p9TtGVJcrygiUhzZNEcRMphieFMq/Z+R4uVyR+gOLXb1wI6GsKCMzzA9iOw6Ck2fWOxzX7NikPm2fMTYuz6+Ng2Xx5ialu7FGWFeqmRRwnDPg8xz/O8iOAGN/u2O9Nvqek0fvfLXdznS5aX+f5P8DLUyYqI0lS7vrhaOFo2dz1P28b9q2aPhP5DvjClA7RvaMSadSoEbphPP40P/1t/gE/lLzSQjd27wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"schema failover\"\n        title=\"schema failover\"\n        src=\"/static/0b40409ff0374b8d105c68dfa76bfa3f/dd6e8/schema_failover.png\"\n        srcset=\"/static/0b40409ff0374b8d105c68dfa76bfa3f/53f68/schema_failover.png 213w,\n/static/0b40409ff0374b8d105c68dfa76bfa3f/df70d/schema_failover.png 425w,\n/static/0b40409ff0374b8d105c68dfa76bfa3f/dd6e8/schema_failover.png 799w\"\n        sizes=\"(max-width: 799px) 100vw, 799px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Le détail des flux serait donc le suivant :</p>\n<ul>\n<li>Problème sur la production (serveur OVH) qui rend le site web indisponible</li>\n<li>Un script sur le serveur backup vérifie régulièrement la disponibilité du site web</li>\n<li>Le script constate l'indisponibilité et via les API OVH change l'IP publique du site en question en la faisant pointer sur le serveur de backup lui-même</li>\n<li>Avec un TTL assez faible (60), l'utilisateur devrait avoir accès au site web via le backup</li>\n</ul>\n<p>Il reste le sujet de la synchronisation des données, solutions possibles :</p>\n<ul>\n<li>Un montage sur le dossier du site web en question</li>\n<li>Un rsync depuis le backup vers la prod à une fréquence régulière</li>\n<li>Un rsync depuis la prod vers le backup dès qu'un fichier est modifié</li>\n</ul>\n<p>J'ai passé pas mal de temps sur ces solutions car elles ont toutes leurs problèmes :</p>\n<ul>\n<li><strong>Montage</strong> : Aucun intérêt car si la prod plante je n'ai plus de montage et donc plus de donnée, il faut forcément une copie. Je peux toujours par la suite via un cron faire une copie régulière des données en local mais aucun intérêt par rapport aux autres solutions.</li>\n<li><strong>Rsync depuis le backup</strong> : Pas trop fan de créer des accès sur mon serveur de prod même si c'est du rsync via clé SSH sur un user non root. Mais surtout comment je détecte qu'un fichier a changé ou été créé ? Seule la prod peut avoir ses infos. J'ai tout de même essayé de créer un montage sshfs avec une surveillance du dossier via l'outil inotify mais cela ne marche pas du tout ensemble, inotify fonctionne avec un système de fichier local.</li>\n<li><strong>Rsync depuis la prod</strong> : Dernière solution, celle-ci parait la plus \"faisable\" la prod surveillant ses fichiers via inotify ou un autre outil et rsync en cas de changement. Par contre avec l'IP dynamique je suis toujours \"bloqué\" car à chaque redémarrage de ma box je change d'IP. J'ai donc dû faire appel à un service type DynDNS, ma box ne gérant que DynDNS ou NoIP j'ai choisi ce dernier qui a une version freemium (il faut valider manuellement le domaine tous les mois sinon 5€/mois...)</li>\n</ul>\n<h1 id=\"mise-en-place\" style=\"position:relative;\"><a href=\"#mise-en-place\" aria-label=\"mise en place permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mise en place</h1>\n<p>J'ai 4 parties à mettre en place :</p>\n<ul>\n<li>Le script de vérification de la disponibilité du site web.</li>\n<li>Le script de changement du DNS.</li>\n<li>L'outil qui va permettre la synchro des données de la prod vers le backup.</li>\n<li>Des petits scripts annexes pour alerter en cas de défaillance de la prod/backup.</li>\n</ul>\n<p>Toute la partie scripting va être condensée dans un seul et même script</p>\n<h2 id=\"partie-scripting\" style=\"position:relative;\"><a href=\"#partie-scripting\" aria-label=\"partie scripting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Partie scripting</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">from urllib.request import urlopen, Request\nfrom urllib.error import HTTPError, URLError\nimport sys\nimport time\nimport requests\nimport dns.resolver\nimport ovh\n\nnew_ip = requests.get('https://api.ipify.org').content.decode('utf8') #Dynamic public IP\ndomain = \"beerus.fr\"\nsite_name = \"&lt;the_website_to_monitor>\"\nifttt_event = \"&lt;event_ifttt_name>\" #See https://ifttt.com\nifttt_key = \"&lt;event_ifttt_key>\" #See https://ifttt.com\novh_secret = \"&lt;ovh_secret>\" #See https://docs.ovh.com/ca/fr/api/first-steps-with-ovh-api/\novh_key = \"&lt;ovh_key>\" #See https://docs.ovh.com/ca/fr/api/first-steps-with-ovh-api/\novh_consumer = \"&lt;ovh_consumer>\" #See https://docs.ovh.com/ca/fr/api/first-steps-with-ovh-api/\n\n# setting the URL you want to monitor\nURL = Request(\"https://{0}.{1}\".format(site_name, domain),\n              headers={'User-Agent': 'Mozilla/5.0'})\ni = 0\n\n#Verify status of the DNS\nresult = dns.resolver.query(site_name, 'A')\nfor ipval in result:\n    if ipval.to_text() == new_ip:\n        print(\"Already switched\")\n        sys.exit(0)\n\n#The site is answering ?\nwhile i &lt; 10:\n    time.sleep(5)\n    print(URL.full_url)\n    try:\n        response = urlopen(URL, timeout=2)\n    except (HTTPError, URLError) as error:\n        i = i+1\n        continue\n    if response.status == 200:\n        print(\"Prod is okay\")\n        break\n    i = i+1\n\n#The website is down so we can switch and alert\nif i == 10:\n    response = requests.post('https://maker.ifttt.com/trigger/{0}/with/key/{1}'.format(ifttt_event, ifttt_key))\n    client = ovh.Client(\n        endpoint='ovh-eu',\n        application_key=ovh_key,\n        application_secret=ovh_secret,\n        consumer_key=ovh_consumer,\n    )\n\n    result = client.put(\n        '/domain/zone/{0}/record/5206233547'.format(domain),\n        subDomain=site_name,\n        target=new_ip,\n        ttl=60,\n    )\n\n    result = client.post('/domain/zone/{0}/refresh'.format(domain))</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Le script ci-dessus a été passé en cron sur le serveur backup et est exécuté toutes les 10 minutes.<br>\nIl exécute les actions suivantes :</p>\n<ul>\n<li>Vérification du DNS (le site a-t-il déjà basculé ?)</li>\n<li>Curl vers le site en question, 10 tests avec un intervalle de 5s</li>\n<li>Si down bascule vers le backup via les API d'OVH</li>\n<li>Notification (on verra ça dans une autre partie)</li>\n</ul>\n<h2 id=\"synchronisation-donnees\" style=\"position:relative;\"><a href=\"#synchronisation-donnees\" aria-label=\"synchronisation donnees permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Synchronisation données</h2>\n<p>Pour la synchro j'avais dans un premier temps pensé à inotify avec rsync.<br>\nIl aurait suffi de lancer le binaire (via systemd dans l'idéal) et dès lors qu'il aurait remarqué un event qui match avec les options précisées (create, delete, move etc...) il effectuerait un rsync.<br>\nLe problème étant que cela nécessite pas mal de bricolage (script, création d'un systemd etc...) et j'aurais aimé en éviter le plus possible.\nHeureusement je suis tombé sur l'outil <strong>lsyncd</strong> qui fait exactement ce travail, pas besoin de réinventer la roue !\nEn plus il peut se baser sur rsync pour faire ses actions ce qui est parfait pour moi. J'ai fait deux configurations :</p>\n<ul>\n<li>Une pour le webroot de mon site, en cas de modification/ajout/suppression lsyncd exécute un rsync immédiatement vers mon backup</li>\n<li>Une pour le dossier des certificats de mon site web, étant donné que je suis sous LetsEncrypt les certificats sont renouvelés régulièrement. De la même façon dès qu'il y a une modification de ceux-ci (le certificat public à priori) il copie le nouveau certificat sur le backup</li>\n</ul>\n<p>Tous cela est parfait mais il me manque encore la partie SSH pure car mon serveur backup est hébergé chez moi derrière ma box. J'utilise déjà le port 22 pour d'autres usages donc il va falloir faire de la configuration additionnelle.<br>\nJ'avais deux possibilités :</p>\n<ul>\n<li>Je fais un NAT sur un port différent du 22 (du style IP_PUB:2222 --> backup:22)</li>\n<li>Je fais un bastion SSH avec un hardenning et qui forward mes requêtes vers mon backup</li>\n</ul>\n<p>J'ai décidé de faire la deuxième solution, ça permet de s'entrainer sur quelque chose que je n'ai pas l'habitude de faire 🙂. Je passe la partie hardenning car ce n'est pas ce que j'ai envie d'aborder dans ce post mais ça consiste à faire les choses suivantes (non exhaustives) :</p>\n<ul>\n<li>Fail2ban</li>\n<li>No PermitRoot</li>\n<li>Authentification par clé uniquement</li>\n<li>Un Jail chroot avec un nombre de binaire limité (adios su et sudo 😈)</li>\n</ul>\n<p>Par rapport au bastion, 3 solutions pour faire ce jump :</p>\n<ul>\n<li>Stockage des clés SSH sur le bastion</li>\n<li>Forwarding SSH agent</li>\n<li>Utiliser ProxyCommand/ProxyJump</li>\n</ul>\n<p><strong>Stockage des clés SSH sur le bastion</strong>: Cela signifie que le bastion possède la clé SSH privée de mon serveur backup, étant donné qu'il reste public cela est toujours dangereux. On met cette idée de côté pour l'instant.<br>\n<strong>Forwarding SSH agent</strong>: On passe nos clés privées à un agent SSH puis on forward cet agent sur notre bastion. L'agent SSH étant une socket Unix (lié à la variable $SSH_AUTH_SOCK) le jump host va pointer vers notre agent local au lieu de pointer sur le sien. Mais il suffit d'être root sur le bastion pour faire pointer sa variable $SSH_AUTH_SOCK sur notre socket et accéder au backup. Pas terrible niveau sécu également.<br>\n<strong>ProxyCommand/ProxyJump</strong>: La meilleure solution, le serveur intermédiaire (le bastion) exécute une <code class=\"language-text\">ProxyCommand</code> lors de la connexion et forward l'input et l'output vers le backup. Il suffit pour cela d'utiliser l'option <code class=\"language-text\">-J</code> du binaire SSH.<br>\nEx : <code class=\"language-text\">ssh -J username@bastion username@backup</code>. Le seul problème de cette solution c'est que si je veux préciser une clé SSH privée la commande ne peut pas deviner si cela s'applique au bastion ou au backup. Je suis donc passé via la config SSH :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Host bastion\n    User linux\n    HostName bastion.domain.tld\n    IdentityFile ~/.ssh/bastion_rsa\n\nHost backup #Pas besoin d'être accessible depuis internet donc\n    User backup\n    HostName backup.domain.lan\n    IdentityFile ~/.ssh/backup_rsa\n    ProxyJump bastion.domain.tld</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Et lorsque je fais un simple <code class=\"language-text\">ssh backup</code> (après recopie des clés publiques sur les bons serveurs) la magie opère ! Petit test de modification d'un fichier ça fonctionne bien, le fichier modifié est bien propagé sur le backup 🙂</p>\n<h2 id=\"notifications\" style=\"position:relative;\"><a href=\"#notifications\" aria-label=\"notifications permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notifications</h2>\n<p>Dernier point : le fignolage ! Il s'agit désormais de m'avertir en cas de défaillance de la prod OU du backup (on ne sait jamais lui aussi il peut planter !).<br>\nPour le backup je fais presque que la même chose que le script ci-dessus, j'ai des curl qui interroge régulièrement le nom DynDNS pointant vers mon site web (j'ai configuré mon reverse proxy Nginx pour répondre au vrai nom de mon site web et au nom DynDNS). En cas de défaillance je reçois un mail sur ma boite perso @beerus.fr.</p>\n<p>Par contre pour la prod c'est plus complexe (et plus important aussi). En fait je pourrais faire le même mécanisme que pour le backup mais je ne recevrai jamais le mail @beerus.fr car mon serveur mail est hébergé sur la même machine que mon site web...<br>\nJ'ai commencé à regarder pour pouvoir utiliser les API de Gmail mais très honnetement ça ne me tentait pas trop.<br>\nDonc à la place j'ai utilisé le service <strong>IFTTT</strong>, j'ai trouvé le concept tellement simple et efficace.\nUne application Android (ou Apple) à télécharger ensuite \"programmer\" son alerte :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 757px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7508569b10bf3ac074b7b9ce1309c7e3/70668/ifttt.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.79342723004696%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACqElEQVQ4y42TWUiUURSAr6aFFdGTBC0Q0UYGEYRBD70E2UPLa09B0Js9hS22Gr30olmmOaMt4+joNGlEikG0gDqbk+aWW4VMkOU4FvWQzsz94t77a5pL/fD95/yHc89/7lnE/T7IboKzfrgUNHKSM76Z+uT3+cAfLgbhWgiutEJRF4gdHljthGMvQRSDKAJxB8RtECXSyGJpYemFGG6AuAkpNnNmfRWIPY8huxk8740xsw4ONsK6Stjultppo0uypVqS8RA2uCRJpZLkUjRJpSBKTQI6YFY9pDtgaw0stsPyclhWDotshhSbJNUOqWVGV9mklUnSyphC+SfbYJsbxNAPCH6F0Ah0jkKHRZdG0j0Goc+/CIR/ar1zVE75dE7jbQT6v4FgwSeh3x+7Q7Q1v5hmk/OeEIPfwTsM7RHoG4Nei3dj0BOVWnaOxGn/Mq71rqi0QNMThe6oyVLFEidew65ayHBbHS62KDF1UQ1QtU2xq5rKqZoplpabGq51wioH7K4DcbkVrreDsx9OeSHXD3mtcLgRshokx1/BzkeSA/WSfU/hyDNJZq1kc42aAtPEybHZVA1ifwOsccLeJ3D0OZxsgkONZnyWlEk9ASqzFXcVsPKemk2p50/csigyM5n+AERFP+T44EIATvsgx2s2IjdgbOf8krw2uPxGZS/1dqituBoyN8mzdLUxelNm90lOk6bLwx96GegIztHl2d0WcQmxxCTSAibikvFYXB8ZCn+ib2BQH1C2iXhilr8invgrQynlDLnQM5+vmM8xEokQCATw+Xy0tLRolO73+wmHw/P+eM4MY7EYlZWVFBQU4HA4tO5yuahwOCgsLMRmsxGNRv+d4fSAVVVV5Ofn64Aejwe3261tKqDdbv+/gLOv7J9xZa/Xq78XuvJvVvnCPbv8G/UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ifttt\"\n        title=\"ifttt\"\n        src=\"/static/7508569b10bf3ac074b7b9ce1309c7e3/70668/ifttt.png\"\n        srcset=\"/static/7508569b10bf3ac074b7b9ce1309c7e3/53f68/ifttt.png 213w,\n/static/7508569b10bf3ac074b7b9ce1309c7e3/df70d/ifttt.png 425w,\n/static/7508569b10bf3ac074b7b9ce1309c7e3/70668/ifttt.png 757w\"\n        sizes=\"(max-width: 757px) 100vw, 757px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Comme on peut le voir ci-dessus en cas de réception d'un webhook on envoie une notification push à l'application IFTTT reliée au compte.<br>\nJ'ai juste eu à ajouter la commande curl à mon script ci-dessus et le tour était joué, ça marche parfaitement ! Très peu d'infos sont également transmise à ce service tiers (surement une ip publique et peut-être des infos négligables concernant mon téléphone) ça reste acceptable de mon côté, le businness plan consiste à proposer des version premium qui permettent de développer son propre algo ou avoir plus d'event.</p>\n<h1 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h1>\n<p>Une grosse journée de travail pour concevoir, mettre en place et peaufiner. J'espérais pas mettre plus de temps et c'est chose faite.\nJ'ai une solution, certes bricolée, mais fonctionnelle et facile. Il me reste tout de même une partie manuelle : en cas de défaillance de la prod et de bascule sur le backup, je dois manuellement refaire pointer le DNS vers la prod (bien que j'utilise un script pour ça).\nLa solution n'est de toute façon mise en place que temporairement le temps que je réfléchisse à une nouvelle architecture qui sera bien plus robuste et pensée en amont.<br>\nCela reste malgré tout un très bon exercice, très proche du système ça toujours fait du bien de remettre les mains dans le cambouis 🙂</p>","timeToRead":10,"excerpt":"Contexte Mon serveur hébergé a des petits soucis en ce moment, il a tendance à planter régulièrement malgré le fait que je le supervise…","fileAbsolutePath":"/home/runner/work/blog-beerus/blog-beerus/master/posts/2022/2022-08-18-redondance-sites/index.md","frontmatter":{"title":"Redondance \"du pauvre\" d'un site personnel","categories":["Infra"],"tags":["ovh","python"],"thumbnail":{"childImageSharp":null,"extension":"svg","publicURL":"/static/6653c9ced1b648aa5680b8eebf01fe3f/thumbnail.svg"}}}},"pageContext":{"filter":"/^.*\\/\\d{4}-\\d{2}-\\d{2}-redondance-sites\\/.*$/"}},"staticQueryHashes":[]}